<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç²’å­æ˜Ÿçƒ - æ‰‹åŠ¿æ§åˆ¶</title>
    <style>
        /* ================= 1. åŸºç¡€è®¾ç½® ================= */
        body { 
            margin: 0; 
            overflow: hidden; 
            background-color: #000; 
            font-family: 'Microsoft YaHei', 'Songti SC', serif; 
            color: #fff;
        }
        
        canvas { 
            display: block; 
        }

        /* ================= 2. å…¨æ–°UIè®¾è®¡ç³»ç»Ÿ ================= */
        :root {
            /* è°ƒè‰²æ¿ - å®‡å®™ç§‘æŠ€ä¸»é¢˜ */
            --bg-dark: #0a0a0a;
            --bg-glass: rgba(15, 15, 20, 0.72);
            --bg-glass-hover: rgba(25, 25, 35, 0.85);
            
            --gold-primary: #ffaa00;
            --gold-light: #ffdd66;
            --gold-dark: #cc8800;
            --gold-glow: rgba(255, 170, 0, 0.4);
            
            --blue-accent: #00ccff;
            --purple-accent: #aa66ff;
            --white-pure: #ffffff;
            --white-dim: #b8b8b8;
            
            /* å°ºå¯¸ç³»ç»Ÿ */
            --radius-sm: 6px;
            --radius-md: 10px;
            --radius-lg: 16px;
            --radius-xl: 24px;
            
            --spacing-xs: 4px;
            --spacing-sm: 8px;
            --spacing-md: 12px;
            --spacing-lg: 16px;
            --spacing-xl: 20px;
            
            --ui-scale: 1.0;
        }

        @media screen and (max-height: 800px) { :root { --ui-scale: 0.85; } }
        @media screen and (min-width: 2000px) { :root { --ui-scale: 1.1; } }
        :fullscreen { --ui-scale: 1.0; }

        /* ç»ç’ƒæ‹Ÿæ€åŸºç¡€ */
        .glass-panel {
            background: var(--bg-glass);
            backdrop-filter: blur(16px) saturate(180%);
            -webkit-backdrop-filter: blur(16px) saturate(180%);
            border-radius: var(--radius-lg);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4), inset 0 1px 0 rgba(255, 255, 255, 0.06);
            overflow: hidden;
            box-sizing: border-box;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .glass-panel:hover {
            background: var(--bg-glass-hover);
            border-color: var(--gold-glow);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.5), 0 0 20px var(--gold-glow);
        }

        /* åŠ¨ç”»è¿‡æ¸¡ */
        #right-sidebar, #top-left-controls, #bottom-right-controls { 
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.4s cubic-bezier(0.4, 0, 0.2, 1); 
        }
        
        .panel-hidden { 
            transform: translateX(40px) scale(var(--ui-scale)) !important; 
            opacity: 0 !important; 
            pointer-events: none !important; 
        }
        
        .hidden { display: none !important; }

        /* ================= 3. ä¸»è¦UIå®¹å™¨ ================= */
        
        /* å·¦ä¸Šè§’æ§åˆ¶ç»„ - æ ‡é¢˜å’Œç³»ç»Ÿä¿¡æ¯ */
        #top-left-controls { 
            position: absolute; 
            top: var(--spacing-lg); 
            left: var(--spacing-lg); 
            pointer-events: auto; 
            display: flex; 
            flex-direction: column; 
            gap: var(--spacing-sm); 
            z-index: 50; 
            transform: scale(var(--ui-scale));
            transform-origin: top left;
        }

        /* å³ä¾§è¾¹æ  - ä¸»è¦æ§åˆ¶ */
        #right-sidebar { 
            position: absolute; 
            top: var(--spacing-lg); 
            right: var(--spacing-lg); 
            width: 280px; 
            height: calc(100vh - var(--spacing-xl) * 2); 
            display: flex; 
            flex-direction: column; 
            gap: var(--spacing-sm); 
            z-index: 20; 
            pointer-events: auto; 
            transform: scale(var(--ui-scale)); 
            transform-origin: top right; 
        }

        /* åº•éƒ¨å·¦ä¸‹è§’ - è°ƒè¯•å’ŒçŠ¶æ€ */
        #bottom-left-controls {
            position: absolute;
            bottom: var(--spacing-lg);
            left: var(--spacing-lg);
            pointer-events: auto;
            display: flex;
            flex-direction: column;
            gap: var(--spacing-sm);
            z-index: 30;
            transform: scale(var(--ui-scale));
            transform-origin: bottom left;
        }

        /* å³ä¸‹è§’ - æ‘„åƒå¤´ */
        #bottom-right-controls {
            position: absolute;
            bottom: var(--spacing-lg);
            right: var(--spacing-lg);
            pointer-events: auto;
            display: flex;
            flex-direction: column;
            gap: var(--spacing-sm);
            z-index: 25;
            transform: scale(var(--ui-scale));
            transform-origin: bottom right;
            /* ç¡®ä¿æ‘„åƒå¤´çª—å£ä¸ä¼šé®æŒ¡å³ä¾§è¾¹æ åº•éƒ¨ */
            max-height: 50vh;
            overflow: visible;
        }

        /* é¡¶éƒ¨ä¸­å¤® - äº¤äº’æç¤º */
        #gesture-hint {
            position: absolute;
            top: var(--spacing-xl);
            left: 50%;
            transform: translateX(-50%);
            color: var(--gold-light);
            font-size: 14px;
            font-weight: 500;
            letter-spacing: 1px;
            background: rgba(0, 0, 0, 0.4);
            padding: 8px 16px;
            border-radius: var(--radius-lg);
            backdrop-filter: blur(8px);
            border: 1px solid rgba(255, 170, 0, 0.3);
            opacity: 0;
            transition: opacity 0.5s ease;
            pointer-events: none;
            z-index: 40;
            text-align: center;
            white-space: nowrap;
        }

        #gesture-hint.show {
            opacity: 1;
        }

        /* ================= 4. æ ‡é¢˜å’Œæ–‡å­—ç³»ç»Ÿ ================= */
        .title-container { 
            background: rgba(0, 0, 0, 0.2);
            padding: var(--spacing-md) var(--spacing-lg);
            border-radius: var(--radius-lg);
            backdrop-filter: blur(4px);
            transition: all 0.3s ease;
            border: 1px solid rgba(255, 170, 0, 0.2);
        }

        .title-container:hover {
            background: rgba(0, 0, 0, 0.3);
            box-shadow: 0 0 20px rgba(255, 170, 0, 0.2);
            border-color: var(--gold-primary);
        }

        .title-main { 
            font-size: 18px; 
            font-weight: 700; 
            color: var(--gold-light); 
            letter-spacing: 2px; 
            text-transform: uppercase;
            text-shadow: 0 0 20px var(--gold-glow);
            margin-bottom: 4px;
        }

        .title-subtitle {
            font-size: 11px;
            color: var(--white-dim);
            letter-spacing: 1px;
            opacity: 0.8;
        }

        /* ================= 5. æ ‡é¢˜å’Œåˆ†ç»„ ================= */
        .section-title { 
            font-size: 13px; 
            font-weight: 700; 
            color: var(--gold-primary); 
            text-transform: uppercase; 
            letter-spacing: 1.5px; 
            padding: var(--spacing-xs) var(--spacing-sm);
            margin: var(--spacing-sm) 0 var(--spacing-xs);
            border-left: 3px solid var(--gold-primary);
            background: linear-gradient(90deg, rgba(255, 170, 0, 0.1) 0%, transparent 100%);
            border-radius: 0 var(--radius-sm) var(--radius-sm) 0;
        }

        .subsection-title {
            font-size: 11px;
            color: var(--white-dim);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-top: var(--spacing-md);
            margin-bottom: var(--spacing-xs);
            opacity: 0.8;
            font-weight: 600;
        }

        /* ================= 6. æ§ä»¶æ ·å¼ ================= */
        
        /* æ»šåŠ¨å®¹å™¨ */
        .scroll-content { 
            flex: 1; 
            overflow-y: auto; 
            pointer-events: auto; 
            padding: var(--spacing-sm); 
            display: flex; 
            flex-direction: column; 
            gap: var(--spacing-sm); 
            scrollbar-width: thin; 
            scrollbar-color: var(--gold-primary) transparent;
        }

        .scroll-content::-webkit-scrollbar { width: 4px; }
        .scroll-content::-webkit-scrollbar-track { background: rgba(255, 255, 255, 0.05); border-radius: 2px; }
        .scroll-content::-webkit-scrollbar-thumb { background: var(--gold-primary); border-radius: 2px; }

        /* è¾“å…¥æ¡† */
        .input-glass { 
            background: rgba(0, 0, 0, 0.3); 
            border: 1px solid rgba(255, 255, 255, 0.1); 
            color: var(--gold-light); 
            padding: var(--spacing-xs) var(--spacing-sm);
            font-size: 12px; 
            outline: none; 
            transition: all 0.3s ease; 
            border-radius: var(--radius-sm); 
            width: 100%; 
            box-sizing: border-box; 
            text-align: center; 
            height: 36px;
            font-family: 'Microsoft YaHei', sans-serif;
        }

        .input-glass:focus { 
            border-color: var(--gold-primary); 
            background: rgba(0, 0, 0, 0.5); 
            box-shadow: 0 0 12px var(--gold-glow);
        }

        select.input-glass { 
            cursor: pointer; 
            text-align: left;
            padding-left: var(--spacing-sm);
        }

        select.input-glass option { 
            background: #1a1a1a; 
            color: var(--gold-primary); 
            font-size: 11px;
        }

        /* æ»‘å— */
        input[type=range] { 
            -webkit-appearance: none; 
            width: 100%; 
            background: transparent; 
            margin: var(--spacing-sm) 0; 
            height: 36px;
        }

        input[type=range]:focus { outline: none; }

        input[type=range]::-webkit-slider-runnable-track { 
            width: 100%; 
            height: 4px; 
            cursor: pointer; 
            background: rgba(255, 255, 255, 0.15); 
            border-radius: 2px; 
            box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.5);
        }

        input[type=range]::-webkit-slider-thumb { 
            height: 16px; 
            width: 16px; 
            border-radius: 50%; 
            background: var(--gold-primary); 
            cursor: pointer; 
            -webkit-appearance: none; 
            margin-top: -6px; 
            box-shadow: 0 0 8px var(--gold-glow);
            border: 2px solid var(--bg-dark);
            transition: all 0.2s ease;
        }

        input[type=range]::-webkit-slider-thumb:hover { 
            transform: scale(1.2); 
            background: var(--gold-light);
            box-shadow: 0 0 12px var(--gold-primary);
        }

        input[type=range]::-webkit-slider-thumb:active {
            transform: scale(1.1);
        }

        /* é¢œè‰²é€‰æ‹©å™¨ */
        input[type="color"] { 
            -webkit-appearance: none; 
            border: 2px solid rgba(255, 255, 255, 0.2); 
            width: 40px; 
            height: 24px; 
            cursor: pointer; 
            padding: 0; 
            background: none; 
            border-radius: var(--radius-sm);
            transition: all 0.2s ease;
        }

        input[type="color"]:hover {
            border-color: var(--gold-primary);
            transform: scale(1.05);
        }

        /* æŒ‰é’® */
        .elegant-btn { 
            background: rgba(255, 255, 255, 0.05); 
            border: 1px solid rgba(255, 170, 0, 0.3); 
            color: var(--gold-light); 
            padding: var(--spacing-sm) var(--spacing-md);
            cursor: pointer; 
            text-transform: uppercase; 
            font-size: 11px; 
            transition: all 0.3s ease; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            border-radius: var(--radius-sm); 
            box-sizing: border-box; 
            position: relative; 
            overflow: hidden; 
            font-family: 'Microsoft YaHei', sans-serif; 
            text-decoration: none;
            font-weight: 600;
            letter-spacing: 0.5px;
            height: 36px;
            gap: 6px;
        }

        .elegant-btn:hover { 
            background: rgba(255, 170, 0, 0.15); 
            border-color: var(--gold-primary); 
            color: var(--white-pure); 
            box-shadow: 0 0 16px var(--gold-glow);
            transform: translateY(-1px);
        }

        .elegant-btn:active { 
            transform: translateY(0) scale(0.98); 
            box-shadow: 0 0 8px var(--gold-glow);
        }

        .elegant-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            pointer-events: none;
        }

        .elegant-btn.primary { 
            background: linear-gradient(135deg, rgba(255, 170, 0, 0.2), rgba(255, 221, 102, 0.1));
            border-color: var(--gold-primary);
        }

        .elegant-btn.primary:hover {
            background: linear-gradient(135deg, rgba(255, 170, 0, 0.3), rgba(255, 221, 102, 0.2));
            box-shadow: 0 0 20px var(--gold-glow);
        }

        .elegant-btn.danger { 
            border-color: rgba(255, 68, 68, 0.5); 
            color: #ff6666; 
        }

        .elegant-btn.danger:hover { 
            background: rgba(255, 68, 68, 0.2); 
            border-color: #ff4444;
            box-shadow: 0 0 16px rgba(255, 68, 68, 0.4);
        }

        /* ä¸Šä¼ æŒ‰é’®ç‰¹æ®Šå¤„ç† */
        .upload-btn {
            position: relative;
        }

        .upload-btn input[type="file"] { 
            position: absolute; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            opacity: 0; 
            cursor: pointer; 
        }

        /* æ§åˆ¶ç»„å®¹å™¨ */
        .control-group { 
            display: flex; 
            flex-direction: column; 
            gap: var(--spacing-xs); 
            margin-bottom: var(--spacing-sm);
            background: rgba(0, 0, 0, 0.2);
            padding: var(--spacing-sm);
            border-radius: var(--radius-sm);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .control-row { 
            display: flex; 
            flex-direction: column; 
            gap: 4px; 
            margin-bottom: var(--spacing-xs); 
        }

        .control-label { 
            color: var(--white-dim); 
            font-size: 10px; 
            font-weight: 700; 
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .control-value {
            color: var(--gold-primary);
            font-weight: 600;
        }

        /* æ–¹å‘æ§åˆ¶ - 3x3ç½‘æ ¼ */
        .direction-pad { 
            display: grid; 
            grid-template-columns: 1fr 1fr 1fr; 
            gap: 4px; 
            margin-top: var(--spacing-sm); 
            padding-top: var(--spacing-sm); 
            border-top: 1px solid rgba(255, 255, 255, 0.08); 
        }

        .dir-btn { 
            background: rgba(255, 255, 255, 0.05); 
            border: 1px solid rgba(255, 170, 0, 0.2); 
            color: var(--gold-light); 
            text-align: center; 
            cursor: pointer; 
            padding: var(--spacing-sm) 0; 
            border-radius: var(--radius-sm); 
            font-size: 12px; 
            user-select: none; 
            transition: 0.2s; 
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .dir-btn:hover { 
            background: rgba(255, 170, 0, 0.2); 
            color: var(--white-pure); 
            box-shadow: 0 0 10px var(--gold-glow);
        }

        .dir-btn:active { 
            background: var(--gold-primary); 
            color: var(--bg-dark); 
            transform: scale(0.95);
        }

        .dir-btn.center {
            font-size: 10px;
            padding: var(--spacing-xs);
        }

        /* äº¤äº’æŒ‰é’®ç½‘æ ¼ */
        .interaction-grid { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: var(--spacing-xs); 
            margin-bottom: var(--spacing-sm); 
        }

        /* ================= 7. æ‘„åƒå¤´é¢„è§ˆ ================= */
        #webcam-wrapper { 
            width: 140px; 
            height: 105px; 
            border: 2px solid var(--gold-primary); 
            border-radius: var(--radius-md); 
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.8); 
            overflow: hidden; 
            background: #000; 
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            transform: scale(var(--ui-scale));
            transform-origin: bottom right;
            position: relative;
            /* ç¡®ä¿ä¸é®æŒ¡å…¶ä»–ç•Œé¢å…ƒç´  */
            margin-bottom: 8px;
        }

        #webcam-wrapper.camera-hidden { 
            opacity: 0; 
            pointer-events: none; 
            transform: translateY(20px) scale(var(--ui-scale)); 
            border-color: rgba(255, 170, 0, 0.2);
        }

        /* åœ¨å°å±å¹•ä¸Šè¿›ä¸€æ­¥ç¼©å°æ‘„åƒå¤´çª—å£ */
        @media (max-width: 768px) {
            #webcam-wrapper { 
                width: 100px; 
                height: 75px; 
            }
        }

        #webcam-canvas { 
            width: 100%; 
            height: 100%; 
            object-fit: cover; 
            transform: scaleX(-1); 
            display: block; 
        }

        #cam-status { 
            position: absolute; 
            bottom: 6px; 
            right: 6px; 
            width: 8px; 
            height: 8px; 
            background: #550000; 
            border-radius: 50%; 
            box-shadow: 0 0 6px #ff0000; 
            z-index: 30; 
            transition: 0.3s; 
            border: 2px solid #000;
        }

        #cam-status.active { 
            background: #00ff00; 
            box-shadow: 0 0 10px #00ff00; 
        }

        /* ================= 8. è°ƒè¯•ä¿¡æ¯ ================= */
        #debug-info { 
            background: rgba(0, 0, 0, 0.6); 
            color: #00ff00;
            font-size: 11px; 
            font-weight: 600;
            font-family: 'Consolas', monospace;
            padding: 8px 12px;
            border-radius: var(--radius-sm);
            border: 1px solid rgba(0, 255, 0, 0.2);
            max-width: 240px;
            line-height: 1.4;
            white-space: pre-wrap;
            word-break: break-all;
        }

        /* ================= 9. ç…§ç‰‡ç®¡ç†å™¨ ================= */
        #delete-manager { 
            position: absolute; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: rgba(10, 10, 10, 0.92); 
            z-index: 60; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            pointer-events: auto; 
            backdrop-filter: blur(20px);
            opacity: 1;
            transition: opacity 0.3s ease;
        }

        #delete-manager.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .manager-title { 
            color: var(--gold-primary); 
            font-size: 24px; 
            letter-spacing: 3px; 
            margin-bottom: var(--spacing-lg);
            text-shadow: 0 0 20px var(--gold-glow);
            font-weight: 700;
            text-transform: uppercase;
        }

        #photo-grid { 
            display: flex; 
            flex-wrap: wrap; 
            gap: 15px; 
            width: 70%; 
            max-width: 800px;
            height: 50%; 
            overflow-y: auto; 
            justify-content: center; 
            padding: 20px; 
            border: 1px solid rgba(255, 170, 0, 0.3); 
            margin: 20px 0; 
            background: rgba(0, 0, 0, 0.5); 
            border-radius: var(--radius-lg);
            backdrop-filter: blur(8px);
        }

        .photo-item { 
            width: 90px; 
            height: 90px; 
            position: relative; 
            border: 2px solid var(--gold-primary); 
            transition: all 0.3s ease; 
            cursor: pointer; 
            border-radius: var(--radius-sm);
            overflow: hidden;
            background: #000;
        }

        .photo-item:hover { 
            transform: scale(1.1) translateY(-2px); 
            border-color: var(--gold-light); 
            box-shadow: 0 0 20px var(--gold-glow);
            z-index: 10;
        }

        .photo-thumb { 
            width: 100%; 
            height: 100%; 
            object-fit: cover; 
            display: block;
        }

        .delete-x { 
            position: absolute; 
            top: -6px; 
            right: -6px; 
            width: 22px; 
            height: 22px; 
            background: #ff4444; 
            color: white; 
            border-radius: 50%; 
            text-align: center; 
            line-height: 20px; 
            font-size: 14px; 
            cursor: pointer; 
            font-weight: bold; 
            border: 2px solid var(--white-pure);
            transition: all 0.2s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.5);
        }

        .delete-x:hover { 
            transform: scale(1.2) rotate(90deg); 
            background: #ff0000;
            box-shadow: 0 0 12px rgba(255, 0, 0, 0.6);
        }

        .manager-actions { 
            display: flex; 
            gap: var(--spacing-lg); 
            margin-top: var(--spacing-md);
        }

        .manager-actions .elegant-btn {
            min-width: 120px;
            font-size: 12px;
        }

        /* ================= 10. åŠ è½½å™¨ ================= */
        #loader { 
            position: absolute; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: var(--bg-dark); 
            z-index: 100; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            transition: opacity 0.5s ease-out; 
        }

        .spinner { 
            width: 60px; 
            height: 60px; 
            border: 2px solid rgba(255, 170, 0, 0.15); 
            border-top: 3px solid var(--gold-primary); 
            border-radius: 50%; 
            animation: spin 1.2s cubic-bezier(0.4, 0, 0.2, 1) infinite; 
            box-shadow: 0 0 20px var(--gold-glow);
        }

        @keyframes spin { 
            0% { transform: rotate(0deg) scale(1); } 
            50% { transform: rotate(180deg) scale(1.05); } 
            100% { transform: rotate(360deg) scale(1); } 
        }

        .loader-text { 
            color: var(--gold-primary); 
            font-size: 14px; 
            letter-spacing: 6px; 
            margin-top: 30px; 
            text-transform: uppercase;
            font-weight: 700;
        }

        /* ================= 11. å“åº”å¼å¾®è°ƒ ================= */
        @media (max-width: 768px) {
            :root { --ui-scale: 0.8; }
            #right-sidebar { width: 240px; right: 10px; }
            #top-left-controls { left: 10px; }
            #bottom-left-controls { left: 10px; }
            #bottom-right-controls { right: 10px; }
            #webcam-wrapper { width: 120px; height: 90px; }
            .elegant-btn { padding: 6px 10px; font-size: 11px; }
        }

        /* ================= 12. å¿«æ·é”®é¢æ¿ ================= */
        #shortcuts-panel {
            background: rgba(0, 0, 0, 0.5);
            padding: 12px;
            border-radius: var(--radius-md);
            border: 1px solid rgba(255, 170, 0, 0.2);
            font-size: 10px;
            backdrop-filter: blur(8px);
        }

        #shortcuts-panel div {
            display: flex;
            justify-content: space-between;
            margin-bottom: 4px;
            color: var(--white-dim);
        }

        #shortcuts-panel span:first-child {
            color: var(--gold-primary);
            font-weight: 700;
            margin-right: 8px;
        }

        #shortcuts-panel span:last-child {
            color: var(--gold-light);
            opacity: 0.8;
        }

        /* éšè—æ»šåŠ¨æ¡ä½†ä¿ç•™åŠŸèƒ½ */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* å¼ºåˆ¶éšè—æ‰€æœ‰è§†é¢‘å…ƒç´ ï¼Œé¿å…åŒé‡ç”»é¢ */
        video {
            position: absolute !important;
            width: 1px !important;
            height: 1px !important;
            opacity: 0 !important;
            pointer-events: none !important;
            z-index: -1 !important;
            visibility: hidden !important;
        }
    </style>

    <!-- å¼•å…¥ MediaPipe å’Œ Three.js - ä¿æŒåŸæœ‰CDN -->
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>

    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js"
            }
        }
    </script>

    <script>
        // ç®€åŒ–ç‰ˆå®‰å…¨æ£€æŸ¥ - ä»…åšå¿…è¦æ£€æŸ¥
        function checkSecurityContext() {
            const isSecure = window.isSecureContext;
            const protocol = window.location.protocol;
            const isLocalhost = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
            
            console.log(`Security Check:`, {
                secure: isSecure,
                protocol: protocol,
                localhost: isLocalhost,
                hasCamera: !!navigator.mediaDevices
            });

            if (!isSecure && !isLocalhost) {
                console.warn('âš ï¸ éå®‰å…¨ç¯å¢ƒ - å¯èƒ½æ— æ³•ä½¿ç”¨æ‘„åƒå¤´');
                const loaderEl = document.getElementById('loader');
                if (loaderEl) {
                    loaderEl.innerHTML = `è¯·ä½¿ç”¨HTTPSæˆ–localhostè®¿é—®<br><span style="font-size:0.8rem;">å½“å‰: ${protocol}</span>`;
                }
            }
            
            return true; // æ€»æ˜¯å°è¯•ç»§ç»­
        }

        // ç®€åŒ–ç‰ˆæ‘„åƒå¤´æƒé™è¯·æ±‚
        async function requestCameraPermission() {
            try {
                console.log('è¯·æ±‚æ‘„åƒå¤´æƒé™...');
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { width: 640, height: 480, facingMode: 'user' } 
                });
                console.log('âœ… æ‘„åƒå¤´æƒé™è·å–æˆåŠŸ');
                stream.getTracks().forEach(track => track.stop());
                return true;
            } catch (error) {
                console.error('âŒ æ‘„åƒå¤´æƒé™å¤±è´¥:', error);
                const loaderEl = document.getElementById('loader');
                if (loaderEl) {
                    loaderEl.innerHTML = `æ‘„åƒå¤´è®¿é—®å¤±è´¥<br><span style="font-size:0.8rem;">é”™è¯¯: ${error.message}</span>`;
                    loaderEl.style.color = '#ff4444';
                }
                throw error;
            }
        }
    </script>
</head>
<body>

    <!-- åŠ è½½ç•Œé¢ -->
    <div id="loader">
        <div class="spinner"></div>
        <div class="loader-text">SYSTEM INITIALIZING</div>
    </div>

    <!-- é¡¶éƒ¨ä¸­å¤®äº¤äº’æç¤º -->
    <div id="gesture-hint">æ­£åœ¨åˆå§‹åŒ–ç³»ç»Ÿ...</div>

    <!-- å·¦ä¸Šè§’ï¼šæ ‡é¢˜å’Œç³»ç»Ÿä¿¡æ¯ -->
    <div id="top-left-controls">
        <div class="glass-panel title-container">
            <div class="title-main">Hand Control Universe</div>
            <div class="title-subtitle">ç²’å­æ˜Ÿçƒ - æ‰‹åŠ¿äº¤äº’ç³»ç»Ÿ</div>
        </div>
        
        <div id="shortcuts-panel" class="glass-panel">
            <div style="font-weight: 700; color: var(--gold-primary); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px; border-bottom: 1px solid rgba(255, 170, 0, 0.3); padding-bottom: 4px;">
                âŒ¨ï¸ å¿«æ·é”®
            </div>
            <div><span>H</span><span>æ˜¾ç¤º/éšè—ç•Œé¢</span></div>
            <div><span>ç©ºæ ¼</span><span>é‡ç½®æ—‹è½¬</span></div>
            <div><span>Z</span><span>åˆ‡æ¢ç…§ç‰‡</span></div>
            <div><span>C</span><span>æ˜¾ç¤º/éšè—æ‘„åƒå¤´</span></div>
            <div><span>â†‘â†“â†â†’</span><span>æ‰‹åŠ¨æ—‹è½¬</span></div>
        </div>
    </div>

    <!-- å³ä¾§è¾¹æ ï¼šä¸»è¦æ§åˆ¶é¢æ¿ -->
    <div id="right-sidebar">
        <div class="glass-panel scroll-content">
            
            <!-- åœºæ™¯å®šåˆ¶ -->
            <div class="section-title">åœºæ™¯å®šåˆ¶</div>

            <div class="control-group">
                <div class="control-row">
                    <label class="control-label">
                        æ—‹è½¬é€Ÿåº¦ <span class="control-value" id="rotation-value">1.4</span>
                    </label>
                    <input type="range" min="0.1" max="5.0" step="0.1" value="1.4" oninput="updateRotationSpeed(this.value)">
                </div>
            </div>

            <!-- å½¢æ€åˆ‡æ¢ -->
            <div class="subsection-title">å½¢æ€åˆ‡æ¢</div>
            <div class="interaction-grid">
                <button class="elegant-btn primary" onclick="setMode('TREE')">
                    <span>èšåˆ</span>
                </button>
                <button class="elegant-btn" onclick="cycleNextPhoto()">
                    <span>æŠ“å–ç…§ç‰‡</span>
                </button>
            </div>

            <!-- ç²’å­æ§åˆ¶ -->
            <div class="subsection-title">ç²’å­æ§åˆ¶</div>
            <div class="control-group">
                <div class="control-row">
                    <label class="control-label">
                        æ˜Ÿçƒå¯†åº¦ <span class="control-value" id="tree-value">4000</span>
                    </label>
                    <input type="range" min="2000" max="8000" step="500" value="4000" id="slider-tree" oninput="document.getElementById('tree-value').textContent=this.value">
                </div>
                <div class="control-row">
                    <label class="control-label">
                        ç¯å¸¦å¯†åº¦ <span class="control-value" id="dust-value">3000</span>
                    </label>
                    <input type="range" min="1000" max="6000" step="500" value="3000" id="slider-dust" oninput="document.getElementById('dust-value').textContent=this.value">
                </div>
            </div>

            <!-- æ‰‹åŠ¿è¯´æ˜ -->
            <div class="subsection-title">æ‰‹åŠ¿è¯´æ˜</div>
            <div class="control-group" style="font-size: 11px; line-height: 1.6; color: var(--white-dim);">
                <div>ğŸ”„ æ—‹è½¬æ‰‹æŒ â†’ æ—‹è½¬æ˜Ÿçƒ</div>
                <div>âœŠ æ¡æ‹³ + è¿œç¦» â†’ å¿«é€Ÿæ‹‰è¿œ</div>
                <div>ğŸ– å¼ å¼€ + é è¿‘ â†’ å¿«é€Ÿæ‹‰è¿‘</div>
            </div>

            <button class="elegant-btn primary" style="width: 100%; margin-top: 8px;" onclick="applyParticleSettings()">
                âš¡ é‡ç½®åœºæ™¯
            </button>

            <!-- èµ„æºç®¡ç† -->
            <div class="section-title" style="margin-top: 16px;">èµ„æºç®¡ç†</div>

            <div class="control-group">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 6px;">
                    <label class="elegant-btn upload-btn">
                        <span>+ ä¸Šä¼ ç…§ç‰‡</span>
                        <input type="file" id="file-input" multiple accept="image/*">
                    </label>
                    <button class="elegant-btn" onclick="openDeleteManager()">
                        <span>ç®¡ç†ç…§ç‰‡</span>
                    </button>
                </div>
            </div>

            <!-- æ‘„åƒå¤´æ§åˆ¶ -->
            <div class="control-group">
                <button class="elegant-btn" id="toggle-cam-btn" onclick="toggleCameraDisplay()">
                    <span>ğŸ“· éšè—/æ˜¾ç¤ºç”»é¢</span>
                </button>
            </div>

            <!-- æ‰‹åŠ¨æ§åˆ¶ -->
            <div class="section-title" style="margin-top: 16px;">æ‰‹åŠ¨æ§åˆ¶</div>
            <div class="control-group">
                <div class="direction-pad">
                    <div></div>
                    <div class="dir-btn" onmousedown="startRotate('up')" onmouseup="stopRotate()" onmouseleave="stopRotate()">â–²</div>
                    <div></div>
                    <div class="dir-btn" onmousedown="startRotate('left')" onmouseup="stopRotate()" onmouseleave="stopRotate()">â—€</div>
                    <div class="dir-btn center" onclick="resetRotation()" title="é‡ç½®æ—‹è½¬">â—</div>
                    <div class="dir-btn" onmousedown="startRotate('right')" onmouseup="stopRotate()" onmouseleave="stopRotate()">â–¶</div>
                    <div></div>
                    <div class="dir-btn" onmousedown="startRotate('down')" onmouseup="stopRotate()" onmouseleave="stopRotate()">â–¼</div>
                    <div></div>
                </div>
            </div>

            <!-- ç•Œé¢æ§åˆ¶ -->
            <div class="section-title" style="margin-top: 16px;">ç•Œé¢æ§åˆ¶</div>
            <div class="interaction-grid">
                <button class="elegant-btn" onclick="toggleUI()">
                    <span>ğŸ‘ï¸ éšè—ç•Œé¢</span>
                </button>
                <button class="elegant-btn" onclick="toggleFullScreen()">
                    <span>â›¶ å…¨å±</span>
                </button>
            </div>

        </div>
    </div>

    <!-- å·¦ä¸‹è§’ï¼šè°ƒè¯•ä¿¡æ¯ -->
    <div id="bottom-left-controls">
        <div id="debug-info" class="glass-panel">ç­‰å¾…åˆå§‹åŒ–...</div>
    </div>

    <!-- å³ä¸‹è§’ï¼šæ‘„åƒå¤´é¢„è§ˆ -->
    <div id="bottom-right-controls">
        <div id="webcam-wrapper" class="glass-panel">
            <canvas id="webcam-canvas" width="320" height="240"></canvas>
            <div id="cam-status"></div>
        </div>
    </div>

    <!-- MediaPipe éœ€è¦çš„è¾“å…¥è§†é¢‘å…ƒç´  - å®Œå…¨éšè— -->
    <video id="input-video" style="position: absolute; width: 1px; height: 1px; opacity: 0; pointer-events: none; z-index: -1;"></video>

    <!-- ç…§ç‰‡ç®¡ç†å™¨ -->
    <div id="delete-manager" class="hidden">
        <div class="manager-title">ç…§ç‰‡åº“ç®¡ç†</div>
        <div id="photo-grid"></div>
        <div class="manager-actions">
            <button class="elegant-btn danger glass-panel" onclick="clearAllPhotos()">
                æ¸…ç©ºæ‰€æœ‰
            </button>
            <button class="elegant-btn glass-panel" onclick="closeDeleteManager()">
                å…³é—­
            </button>
        </div>
    </div>

    <script type="module">
        import * as THREE from 'three';

        // ==========================================
        // 1. THREE.JS åœºæ™¯è®¾ç½®
        // ==========================================
        const scene = new THREE.Scene();
        // æ·»åŠ ä¸€ç‚¹èƒŒæ™¯é›¾ï¼Œå¢åŠ æ·±é‚ƒæ„Ÿ
        scene.fog = new THREE.FogExp2(0x000000, 0.002);

        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
        document.body.appendChild(renderer.domElement);

        // åˆ›å»ºå‘å…‰ç²’å­çº¹ç†
        function createLightTexture() {
            const canvas = document.createElement('canvas');
            canvas.width = 32;
            canvas.height = 32;
            const context = canvas.getContext('2d');
            const gradient = context.createRadialGradient(16, 16, 0, 16, 16, 16);
            gradient.addColorStop(0, 'rgba(255, 255, 255, 1)');
            gradient.addColorStop(0.2, 'rgba(255, 255, 255, 0.8)');
            gradient.addColorStop(0.5, 'rgba(255, 255, 255, 0.2)');
            gradient.addColorStop(1, 'rgba(0, 0, 0, 0)');
            context.fillStyle = gradient;
            context.fillRect(0, 0, 32, 32);
            const texture = new THREE.Texture(canvas);
            texture.needsUpdate = true;
            return texture;
        }

        const particleTexture = createLightTexture();

        // --- åˆ›å»ºæ˜Ÿçƒ (æ©™è‰²) ---
        let planetGeometry = new THREE.BufferGeometry();
        let planetCount = 4000;
        let planetPos = new Float32Array(planetCount * 3);
        let planetSizes = new Float32Array(planetCount);

        function createPlanetParticles(count) {
            if (window.planetMesh) {
                scene.remove(window.planetMesh);
                window.planetMesh.geometry.dispose();
                window.planetMesh.material.dispose();
            }

            planetCount = count;
            planetPos = new Float32Array(planetCount * 3);
            planetSizes = new Float32Array(planetCount);

            for (let i = 0; i < planetCount; i++) {
                // çƒé¢åˆ†å¸ƒé€»è¾‘ï¼šä½¿å¾—è¶Šé è¿‘è¡¨é¢ç²’å­è¶Šå¤šï¼Œä½†å†…éƒ¨ä¹Ÿæœ‰
                const r = 10 * Math.cbrt(Math.random()); // åŠå¾„åˆ†å¸ƒ
                // ä¿®æ­£çƒé¢åˆ†å¸ƒï¼Œç¡®ä¿è¡¨é¢èšé›†ï¼ˆçƒé¢ï¼‰
                const radius = 8 + Math.random() * 2; // æ ¸å¿ƒåŠå¾„ 8-10
                
                const theta = Math.random() * Math.PI * 2;
                const phi = Math.acos(2 * Math.random() - 1);

                const x = radius * Math.sin(phi) * Math.cos(theta);
                const y = radius * Math.sin(phi) * Math.sin(theta);
                const z = radius * Math.cos(phi);

                planetPos[i * 3] = x;
                planetPos[i * 3 + 1] = y;
                planetPos[i * 3 + 2] = z;

                // ç²’å­å¤§å°éšæœº
                planetSizes[i] = Math.random() * 1.5 + 0.5;
            }

            planetGeometry.setAttribute('position', new THREE.BufferAttribute(planetPos, 3));
            planetGeometry.setAttribute('size', new THREE.BufferAttribute(planetSizes, 1));

            const planetMaterial = new THREE.PointsMaterial({
                color: 0xffaa00, // æ©™è‰²
                size: 0.8,
                map: particleTexture,
                transparent: true,
                blending: THREE.AdditiveBlending,
                depthWrite: false, 
                vertexColors: false
            });

            window.planetMesh = new THREE.Points(planetGeometry, planetMaterial);
            scene.add(window.planetMesh);
        }

        // --- åˆ›å»ºæ˜Ÿç¯ (ç™½è‰²åŒç¯) ---
        let ringGeometry = new THREE.BufferGeometry();
        let ringParticlesCount = 3000;

        function createRingParticles(count) {
            if (window.ringSystem) {
                scene.remove(window.ringSystem);
                ringGeometry.dispose();
                window.ringSystem.material.dispose();
            }

            ringParticlesCount = count;
            const ringPos = new Float32Array(ringParticlesCount * 3);

            for (let i = 0; i < ringParticlesCount; i++) {
                // ç¯ 1: åŠå¾„ 14-18, ç¯ 2: åŠå¾„ 22-26
                const isRing1 = Math.random() > 0.5;
                const baseR = isRing1 ? 14 : 22;
                const ringWidth = 4;
                const r = baseR + Math.random() * ringWidth;
                
                const angle = Math.random() * Math.PI * 2;
                
                // ç¨å¾®å€¾æ–œ
                const x = r * Math.cos(angle);
                const z = r * Math.sin(angle);
                const y = (Math.random() - 0.5) * 1; // æ‰å¹³

                ringPos[i * 3] = x;
                ringPos[i * 3 + 1] = y;
                ringPos[i * 3 + 2] = z;
            }

            ringGeometry.setAttribute('position', new THREE.BufferAttribute(ringPos, 3));
            const ringMaterial = new THREE.PointsMaterial({
                color: 0xffffff,
                size: 0.6,
                map: particleTexture,
                transparent: true,
                blending: THREE.AdditiveBlending,
                depthWrite: false
            });

            window.ringSystem = new THREE.Points(ringGeometry, ringMaterial);
            // è®©ç¯ç¨å¾®å€¾æ–œä¸€ç‚¹
            window.ringSystem.rotation.z = Math.PI / 8;
            window.ringSystem.rotation.x = Math.PI / 8;
            scene.add(window.ringSystem);
        }

        // åˆå§‹åˆ›å»º
        createPlanetParticles(4000);
        createRingParticles(3000);

        // ==========================================
        // 2. æ‘„åƒæœºæ§åˆ¶é€»è¾‘å˜é‡
        // ==========================================
        let targetOrbitAngle = 0;
        let currentOrbitAngle = 0;
        
        let targetDistance = 40;
        let currentDistance = 40;
        const MIN_DISTANCE = 15;
        const MAX_DISTANCE = 150;
        
        // é»˜è®¤è‡ªåŠ¨æ—‹è½¬
        let isHandDetected = false;
        let autoRotateSpeed = 0.001;

        // ==========================================
        // 3. MediaPipe é€»è¾‘
        // ==========================================
        const videoElement = document.getElementById('input-video');
        let hands, cameraUtils;
        let mediaPipeInitialized = false;

        // è°ƒè¯•åŠŸèƒ½
        let debugMode = true; // é»˜è®¤æ˜¾ç¤ºè°ƒè¯•ä¿¡æ¯
        let debugVideoStream = null;

        // æ›´æ–°è°ƒè¯•çŠ¶æ€æ˜¾ç¤º
        function updateDebugStatus(message) {
            const debugStatus = document.getElementById('debug-info');
            if (debugStatus) {
                debugStatus.textContent = message;
            }
            console.log(`[è°ƒè¯•çŠ¶æ€] ${message}`);
        }

        function onResults(results) {
            // éšè—åŠ è½½æç¤º - ä¼˜å…ˆæ‰§è¡Œï¼Œç¡®ä¿ç•Œé¢æ­£å¸¸
            const loaderEl = document.getElementById('loader');
            if (loaderEl && loaderEl.style.display !== 'none') {
                console.log('MediaPipeå·¥ä½œæ­£å¸¸ï¼Œå¼€å§‹éšè—åŠ è½½ç•Œé¢');
                loaderEl.style.opacity = '0';
                setTimeout(() => {
                    if (loaderEl) {
                        loaderEl.style.display = 'none';
                        console.log('âœ… åŠ è½½ç•Œé¢å·²éšè—');
                        // æ˜¾ç¤ºæˆåŠŸæç¤º
                        const hint = document.getElementById('gesture-hint');
                        if (hint) {
                            hint.textContent = "ç³»ç»Ÿå°±ç»ª - è¯·å°è¯•æ‰‹åŠ¿æ§åˆ¶";
                            hint.classList.add('show');
                            setTimeout(() => hint.classList.remove('show'), 3000);
                        }
                    }
                }, 500);
            }

            // åŸå§‹é€»è¾‘ï¼šå¿«é€Ÿå¤±è´¥æ£€æŸ¥ï¼Œç¡®ä¿ç¨³å®š
            if (!results || !results.multiHandLandmarks || results.multiHandLandmarks.length === 0) {
                if (isHandDetected) {
                    isHandDetected = false;
                    updateDebugStatus('æœªæ£€æµ‹åˆ°æ‰‹åŠ¿\nç­‰å¾…æ‰‹åŠ¿è¾“å…¥...');
                }
                return;
            }

            isHandDetected = true;
            const landmarks = results.multiHandLandmarks[0];

            // --- A. æ£€æµ‹æ—‹è½¬ (Based on Hand Tilt) ---
            // ä½¿ç”¨æ‰‹è…•(0)å’Œä¸­æŒ‡æ ¹éƒ¨(9)çš„å‘é‡æ¥è®¡ç®—æ‰‹çš„æ—‹è½¬è§’åº¦
            const wrist = landmarks[0];
            const middleTip = landmarks[9];
            
            // è®¡ç®— x å’Œ y çš„å·®å€¼ (MediaPipe åæ ‡ç³»: x left->right, y top->bottom)
            const dx = middleTip.x - wrist.x;
            const dy = middleTip.y - wrist.y;
            
            // è®¡ç®—è§’åº¦ (-PI to PI)
            // è¿™é‡ŒåŠ ä¸ªç³»æ•°è®©æ—‹è½¬æ›´çµæ•
            let rotationAngle = Math.atan2(dx, -dy); // -dy å› ä¸ºå±å¹•åæ ‡yå‘ä¸‹
            
            // å¹³æ»‘æ›´æ–°ç›®æ ‡è§’åº¦
            // 3.0 æ˜¯å€ç‡ï¼Œè®©æ‰‹è½¬ä¸€ç‚¹ï¼Œæ˜Ÿçƒè½¬å¤šç‚¹
            targetOrbitAngle = rotationAngle * 3.0;


            // --- B. æ£€æµ‹ç¼©æ”¾ (Fist vs Open & Distance) ---
            
            // 1. è®¡ç®—"æ‰‹çš„å¤§å°" (æ‰‹è…•åˆ°ä¸­æŒ‡æŒ‡å°–çš„è·ç¦»ï¼Œè¿‘ä¼¼ä»£è¡¨æ‰‹ç¦»æ‘„åƒå¤´çš„è¿œè¿‘)
            // Zåæ ‡åœ¨2Dæ¨¡å¼ä¸‹ä¸å‡†ï¼Œç”¨å±å¹•æŠ•å½±çš„æ¬§å‡ é‡Œå¾—è·ç¦»æ›´ç¨³
            const sizeRef = Math.sqrt(
                Math.pow(landmarks[0].x - landmarks[9].x, 2) + 
                Math.pow(landmarks[0].y - landmarks[9].y, 2)
            ); 

            // 2. æ£€æµ‹æ¡æ‹³è¿˜æ˜¯å¼ å¼€
            // ç®€å•ç®—æ³•ï¼šæŒ‡å°–(8,12,16,20)åˆ°æ‰‹è…•(0)çš„è·ç¦»å¦‚æœéƒ½å¾ˆçŸ­ï¼Œå°±æ˜¯æ¡æ‹³
            const fingertips = [8, 12, 16, 20];
            let foldedFingers = 0;
            fingertips.forEach(idx => {
                const d = Math.sqrt(Math.pow(landmarks[idx].x - landmarks[0].x, 2) + Math.pow(landmarks[idx].y - landmarks[0].y, 2));
                // é˜ˆå€¼åŸºäºå½“å‰æ‰‹æŒå¤§å° sizeRef
                if (d < sizeRef * 1.6) foldedFingers++; // å¦‚æœæŒ‡å°–è·ç¦»æ‰‹è…•å¾ˆè¿‘
            });

            const isFist = foldedFingers >= 3; // 3æ ¹ä»¥ä¸Šæ‰‹æŒ‡å¼¯æ›²ç®—æ¡æ‹³
            const isOpen = foldedFingers <= 1; // 1æ ¹ä»¥ä¸‹æ‰‹æŒ‡å¼¯æ›²ç®—å¼ å¼€

            // 3. é€Ÿåº¦ä¸è·ç¦»é€»è¾‘
            // sizeRef è¶Šå¤§ï¼Œæ‰‹è¶Šè¿‘ï¼›sizeRef è¶Šå°ï¼Œæ‰‹è¶Šè¿œã€‚
            // æ­£å¸¸èŒƒå›´å¤§çº¦åœ¨ 0.05 (è¿œ) åˆ° 0.4 (è¿‘) ä¹‹é—´
            
            if (isFist) {
                // æ¡æ‹³ + è¿œç¦»(sizeRefå˜å°) -> ç›¸æœºå˜è¿œ
                // é€»è¾‘ï¼šé€Ÿåº¦å…ˆæ…¢åå¿«ã€‚å½“æ‰‹å¾ˆè¿œ(sizeRefå¾ˆå°)æ—¶ï¼Œç›¸æœºè·ç¦»(targetDistance)åº”è¯¥éå¸¸å¤§
                // ä½¿ç”¨åæ¯”å‡½æ•°æ¨¡æ‹Ÿ "æ‹‰è¿œ"
                const factor = Math.max(0.01, sizeRef); 
                // ä¾‹å­å…¬å¼: base + constant / size
                targetDistance = 20 + 5 / factor; 
                
            } else if (isOpen) {
                // å¼ å¼€ + é è¿‘(sizeRefå˜å¤§) -> ç›¸æœºé è¿‘
                // é€»è¾‘ï¼šé€Ÿåº¦å…ˆå¿«åæ…¢ã€‚å½“æ‰‹å¾ˆè¿‘(sizeRefå¾ˆå¤§)æ—¶ï¼Œç›¸æœºè·ç¦»æ¥è¿‘æœ€å°å€¼
                // ä½¿ç”¨è¡°å‡å‡½æ•°
                const factor = Math.min(0.5, sizeRef);
                // çº¿æ€§æ˜ å°„åè½¬ï¼Œä½†åŠ ä¸€ç‚¹æ›²çº¿
                targetDistance = 100 - (factor * 200); 
            }

            // é™åˆ¶èŒƒå›´
            targetDistance = Math.max(MIN_DISTANCE, Math.min(MAX_DISTANCE, targetDistance));
            
            // è°ƒè¯•ä¿¡æ¯
            const gestureText = isFist ? 'æ¡æ‹³' : isOpen ? 'å¼ å¼€' : 'å…¶å®ƒ';
            updateDebugStatus(`æ‰‹åŠ¿è¯†åˆ«: ${gestureText}\nè·ç¦»: ${targetDistance.toFixed(1)}\næ—‹è½¬: ${(targetOrbitAngle).toFixed(2)}`);
        }

        async function initializeMediaPipe() {
            if (mediaPipeInitialized) return;
            
            const mpStart = performance.now();
            updateDebugStatus('æ­£åœ¨åˆå§‹åŒ–MediaPipe...');

            try {
                // ç­‰å¾…MediaPipeåº“åŠ è½½å®Œæˆ
                let retryCount = 0;
                const maxRetries = 10;
                const retryDelay = 300;
                
                while (typeof Hands === 'undefined' && retryCount < maxRetries) {
                    console.log(`ç­‰å¾…MediaPipeåº“åŠ è½½... (${retryCount + 1}/${maxRetries})`);
                    await new Promise(resolve => setTimeout(resolve, retryDelay));
                    retryCount++;
                }

                if (typeof Hands === 'undefined') {
                    throw new Error('MediaPipe Handsåº“æœªåŠ è½½ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–CDNæœåŠ¡');
                }

                // å¼‚æ­¥åˆå§‹åŒ–Hands
                hands = new Hands({locateFile: (file) => {
                    return `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`;
                }});

                hands.setOptions({
                    maxNumHands: 1,
                    modelComplexity: 1,
                    minDetectionConfidence: 0.5,
                    minTrackingConfidence: 0.5
                });

                hands.onResults(onResults);

                // åˆå§‹åŒ–Camera
                cameraUtils = new Camera(videoElement, {
                    onFrame: async () => {
                        if (hands && hands.send && videoElement.readyState === 4) {
                            await hands.send({image: videoElement});
                        }
                    },
                    width: 640,
                    height: 480
                });
                
                await cameraUtils.start();

                mediaPipeInitialized = true;
                console.log(`MediaPipeåˆå§‹åŒ–è€—æ—¶: ${(performance.now() - mpStart).toFixed(2)}ms`);
                updateDebugStatus('MediaPipeåˆå§‹åŒ–å®Œæˆ\nç³»ç»Ÿè¿è¡Œæ­£å¸¸');
                
            } catch (error) {
                console.error('MediaPipeåˆå§‹åŒ–å¤±è´¥:', error);
                updateDebugStatus(`MediaPipeé”™è¯¯: ${error.message}`);
                throw error;
            }
        }

        // æ‘„åƒå¤´é¢„è§ˆæ¸²æŸ“
        function renderWebcamPreview() {
            const canvas = document.getElementById('webcam-canvas');
            const ctx = canvas.getContext('2d', { willReadFrequently: true });
            
            function draw() {
                if (videoElement.readyState >= 2) {
                    ctx.drawImage(videoElement, 0, 0, canvas.width, canvas.height);
                }
                requestAnimationFrame(draw);
            }
            draw();
        }

        // ==========================================
        // 4. æ¸²æŸ“å¾ªç¯
        // ==========================================
        let frameCount = 0;
        let lastFPSTime = 0;
        
        function animate() {
            requestAnimationFrame(animate);

            // --- æ›´æ–°ä½ç½®é€»è¾‘ ---
            if (isHandDetected) {
                // å¹³æ»‘æ’å€¼ (Lerp)
                // æ—‹è½¬æ’å€¼
                currentOrbitAngle += (targetOrbitAngle - currentOrbitAngle) * 0.1;
                
                // è·ç¦»æ’å€¼
                // æ ¹æ®è¦æ±‚ï¼šæ¡æ‹³æ‹‰è¿œ(å…ˆæ…¢åå¿«) å’Œ å¼ å¼€é è¿‘(å…ˆå¿«åæ…¢)
                // è¿™ä¸»è¦é€šè¿‡ targetDistance çš„è®¡ç®—å…¬å¼å†³å®šï¼Œè¿™é‡Œåšå¹³æ»‘è¿‡æ¸¡
                currentDistance += (targetDistance - currentDistance) * 0.08;

            } else {
                // æ— æ‰‹åŠ¿æ—¶ï¼Œç¼“æ…¢è‡ªè½¬ï¼Œè·ç¦»å¤ä½
                currentOrbitAngle += autoRotateSpeed;
                // currentDistance += (40 - currentDistance) * 0.05; // å¯é€‰ï¼šè‡ªåŠ¨å¤ä½
            }

            // æ›´æ–°ç›¸æœºä½ç½® (æåæ ‡è½¬ç¬›å¡å°”åæ ‡)
            // y è½´ç¨å¾®æŠ¬é«˜ä¸€ç‚¹ï¼Œä¿¯è§†è§†è§’
            const y = currentDistance * 0.3; 
            const horizontalDist = Math.sqrt(currentDistance * currentDistance - y * y);
            
            camera.position.x = horizontalDist * Math.sin(currentOrbitAngle);
            camera.position.z = horizontalDist * Math.cos(currentOrbitAngle);
            camera.position.y = y;

            camera.lookAt(0, 0, 0);

            // --- ç²’å­åŠ¨ç”» ---
            // è®©æ˜Ÿçƒæœ¬èº«ä¹Ÿåœ¨è‡ªè½¬ï¼Œå¢åŠ åŠ¨æ„Ÿ
            if (window.planetMesh) window.planetMesh.rotation.y += 0.002;
            if (window.ringSystem) window.ringSystem.rotation.z -= 0.001; // ç¯é€†å‘å¾®è½¬

            renderer.render(scene, camera);

            // FPSè®¡ç®—
            frameCount++;
            const now = performance.now();
            if (now - lastFPSTime >= 500) {
                const fps = Math.round((frameCount * 1000) / (now - lastFPSTime));
                // æ›´æ–°UIä¸­çš„FPSæ˜¾ç¤ºï¼ˆå¦‚æœéœ€è¦ï¼‰
                frameCount = 0;
                lastFPSTime = now;
            }
        }

        // çª—å£å¤§å°è°ƒæ•´
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

        // ==========================================
        // 5. ç•Œé¢äº¤äº’å‡½æ•°
        // ==========================================

        // æ›´æ–°æ—‹è½¬é€Ÿåº¦
        window.updateRotationSpeed = function(value) {
            // è°ƒæ•´è‡ªåŠ¨æ—‹è½¬é€Ÿåº¦
            autoRotateSpeed = parseFloat(value) * 0.001;
            document.getElementById('rotation-value').textContent = value;
        };

        // è®¾ç½®æ¨¡å¼
        window.setMode = function(mode) {
            // ç®€å•çš„æ¨¡å¼åˆ‡æ¢åªæ˜¯ä¸ºäº†è§†è§‰åé¦ˆï¼Œå®é™…åŠŸèƒ½ä¸å˜
            const hint = document.getElementById('gesture-hint');
            if (mode === 'TREE') {
                hint.textContent = "å·²åˆ‡æ¢åˆ°èšåˆæ¨¡å¼";
                // é‡ç½®è·ç¦»
                targetDistance = 40;
            } else {
                hint.textContent = "æ¨¡å¼: " + mode;
            }
            hint.classList.add('show');
            setTimeout(() => hint.classList.remove('show'), 1500);
        };

        // åˆ‡æ¢ç…§ç‰‡ï¼ˆä¿æŒåŸæœ‰é€»è¾‘ï¼‰
        window.cycleNextPhoto = function() {
            const hint = document.getElementById('gesture-hint');
            hint.textContent = "ç…§ç‰‡åˆ‡æ¢åŠŸèƒ½ï¼ˆéœ€å…ˆä¸Šä¼ ç…§ç‰‡ï¼‰";
            hint.classList.add('show');
            setTimeout(() => hint.classList.remove('show'), 2000);
        };

        // æ‰‹åŠ¨æ§åˆ¶æ—‹è½¬
        let manualRotateState = { x: 0, y: 0 };
        window.startRotate = function(direction) {
            const speed = 0.02;
            if (direction === 'up') manualRotateState.x = -speed;
            if (direction === 'down') manualRotateState.x = speed;
            if (direction === 'left') manualRotateState.y = -speed;
            if (direction === 'right') manualRotateState.y = speed;
            
            // ç«‹å³åº”ç”¨æ‰‹åŠ¨æ—‹è½¬
            isHandDetected = false; // æš‚åœæ‰‹åŠ¿æ§åˆ¶çš„å½±å“
            targetOrbitAngle += manualRotateState.y * 10;
            targetDistance += manualRotateState.x * 20;
            targetDistance = Math.max(MIN_DISTANCE, Math.min(MAX_DISTANCE, targetDistance));
        };

        window.stopRotate = function() {
            manualRotateState = { x: 0, y: 0 };
        };

        window.resetRotation = function() {
            targetDistance = 40;
            targetOrbitAngle = 0;
            const hint = document.getElementById('gesture-hint');
            hint.textContent = "ä½ç½®å·²é‡ç½®";
            hint.classList.add('show');
            setTimeout(() => hint.classList.remove('show'), 1500);
        };

        // ç•Œé¢æ˜¾ç¤º/éšè—
        let uiVisible = true;
        window.toggleUI = function() {
            uiVisible = !uiVisible;
            const rightSidebar = document.getElementById('right-sidebar');
            const topLeft = document.getElementById('top-left-controls');
            const bottomLeft = document.getElementById('bottom-left-controls');
            const bottomRight = document.getElementById('bottom-right-controls');
            
            if (uiVisible) {
                rightSidebar.classList.remove('panel-hidden');
                topLeft.classList.remove('panel-hidden');
                bottomLeft.classList.remove('panel-hidden');
                bottomRight.classList.remove('panel-hidden');
            } else {
                rightSidebar.classList.add('panel-hidden');
                topLeft.classList.add('panel-hidden');
                bottomLeft.classList.add('panel-hidden');
                bottomRight.classList.add('panel-hidden');
            }

            const hint = document.getElementById('gesture-hint');
            hint.textContent = uiVisible ? "ç•Œé¢å·²æ˜¾ç¤º" : "ç•Œé¢å·²éšè—";
            hint.classList.add('show');
            setTimeout(() => hint.classList.remove('show'), 1500);
        };

        // æ‘„åƒå¤´æ˜¾ç¤º/éšè—
        let cameraVisible = true;
        window.toggleCameraDisplay = function() {
            cameraVisible = !cameraVisible;
            const wrapper = document.getElementById('webcam-wrapper');
            const btn = document.getElementById('toggle-cam-btn');
            
            if (cameraVisible) {
                wrapper.classList.remove('camera-hidden');
                if (btn) btn.innerHTML = '<span>ğŸ“· éšè—ç”»é¢</span>';
            } else {
                wrapper.classList.add('camera-hidden');
                if (btn) btn.innerHTML = '<span>ğŸ“· æ˜¾ç¤ºç”»é¢</span>';
            }
        };

        // å…¨å±
        window.toggleFullScreen = function() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen();
            } else {
                document.exitFullscreen();
            }
        };

        // åº”ç”¨ç²’å­è®¾ç½®
        window.applyParticleSettings = function() {
            const planetCount = parseInt(document.getElementById('slider-tree').value);
            const ringCount = parseInt(document.getElementById('slider-dust').value);
            
            createPlanetParticles(planetCount);
            createRingParticles(ringCount);
            
            const hint = document.getElementById('gesture-hint');
            hint.textContent = "åœºæ™¯å·²æ›´æ–°";
            hint.classList.add('show');
            setTimeout(() => hint.classList.remove('show'), 1500);
        };

        // ç…§ç‰‡ç®¡ç†å™¨
        window.openDeleteManager = function() {
            const manager = document.getElementById('delete-manager');
            manager.classList.remove('hidden');
            updatePhotoManager();
        };

        window.closeDeleteManager = function() {
            document.getElementById('delete-manager').classList.add('hidden');
        };

        window.clearAllPhotos = function() {
            if (confirm("ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰ç…§ç‰‡å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚")) {
                closeDeleteManager();
                const hint = document.getElementById('gesture-hint');
                hint.textContent = "ç…§ç‰‡å·²æ¸…ç©º";
                hint.classList.add('show');
                setTimeout(() => hint.classList.remove('show'), 1500);
            }
        };

        // æ–‡ä»¶ä¸Šä¼ å¤„ç† - å®Œæ•´å®ç° + å®‰å…¨ä¿æŠ¤
        function setupFileUpload() {
            const fileInput = document.getElementById('file-input');
            if (fileInput) {
                fileInput.addEventListener('change', async (e) => {
                    // æ£€æŸ¥æ˜¯å¦æ­£åœ¨å¤„ç†ï¼Œé˜²æ­¢é‡å¤ç‚¹å‡»
                    if (window.isProcessingPhotos) {
                        showHint("æ­£åœ¨å¤„ç†ä¸­ï¼Œè¯·ç¨å€™...");
                        return;
                    }

                    const files = e.target.files;
                    if (files.length === 0) return;

                    // å®‰å…¨æ£€æŸ¥ï¼šæ£€æŸ¥å­˜å‚¨é…é¢
                    try {
                        if (navigator.storage && navigator.storage.estimate) {
                            const estimate = await navigator.storage.estimate();
                            const quota = estimate.quota;
                            const usage = estimate.usage;
                            const availableMB = (quota - usage) / (1024 * 1024);
                            
                            if (availableMB < 10) {
                                showHint("å­˜å‚¨ç©ºé—´ä¸è¶³ï¼Œè¯·åˆ é™¤ä¸€äº›ç…§ç‰‡");
                                return;
                            }
                        }
                    } catch (e) {
                        console.warn("å­˜å‚¨é…é¢æ£€æŸ¥å¤±è´¥:", e);
                    }

                    // é™åˆ¶å•æ¬¡ä¸Šä¼ æ•°é‡ï¼Œé¿å…æ‰¹é‡å¤„ç†å¯¼è‡´å¡é¡¿
                    const maxBatchSize = 5;
                    if (files.length > maxBatchSize) {
                        showHint(`å•æ¬¡æœ€å¤šä¸Šä¼ ${maxBatchSize}å¼ ï¼Œå°†å¤„ç†å‰${maxBatchSize}å¼ `);
                    }

                    window.isProcessingPhotos = true;
                    const hint = document.getElementById('gesture-hint');
                    hint.textContent = `æ­£åœ¨å¤„ç† ${Math.min(files.length, maxBatchSize)} å¼ ç…§ç‰‡...`;
                    hint.classList.add('show');

                    // è·å–ç°æœ‰ç…§ç‰‡
                    let photos = JSON.parse(localStorage.getItem('webAR_photos') || '[]');
                    
                    // é™åˆ¶æ€»ç…§ç‰‡æ•°é‡ï¼Œé¿å…å­˜å‚¨æº¢å‡º
                    const maxPhotos = 15; // é™ä½åˆ°15å¼ 
                    if (photos.length >= maxPhotos) {
                        showHint(`ç…§ç‰‡åº“å·²æ»¡ï¼ˆæœ€å¤š${maxPhotos}å¼ ï¼‰ï¼Œè¯·åˆ é™¤åå†ä¸Šä¼ `);
                        window.isProcessingPhotos = false;
                        return;
                    }

                    const filesToProcess = Array.from(files).slice(0, maxBatchSize);
                    let processedCount = 0;

                    // å¤„ç†æ¯ä¸ªæ–‡ä»¶ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
                    for (let file of filesToProcess) {
                        try {
                            if (!file.type.startsWith('image/')) continue;
                            
                            // æ£€æŸ¥æ–‡ä»¶å¤§å°ï¼ˆé™åˆ¶2MBä»¥å†…ï¼‰
                            if (file.size > 2 * 1024 * 1024) {
                                console.warn(`è·³è¿‡è¿‡å¤§æ–‡ä»¶: ${file.name}`);
                                continue;
                            }

                            // å‹ç¼©å¹¶è½¬æ¢ä¸ºBase64
                            const base64 = await compressImage(file);
                            if (base64) {
                                photos.push({
                                    id: Date.now() + Math.random(),
                                    data: base64,
                                    name: file.name,
                                    timestamp: new Date().toISOString()
                                });
                                processedCount++;
                            }
                        } catch (error) {
                            console.error(`å¤„ç†æ–‡ä»¶ ${file.name} å¤±è´¥:`, error);
                        }
                    }

                    // å†æ¬¡é™åˆ¶æ•°é‡ï¼ˆé˜²æ­¢è¶…é™ï¼‰
                    if (photos.length > maxPhotos) {
                        photos = photos.slice(-maxPhotos);
                    }

                    // ä¿å­˜åˆ°localStorageï¼Œæ·»åŠ å¼‚å¸¸å¤„ç†
                    try {
                        localStorage.setItem('webAR_photos', JSON.stringify(photos));
                    } catch (error) {
                        console.error("localStorageä¿å­˜å¤±è´¥:", error);
                        showHint("å­˜å‚¨å¤±è´¥ï¼Œå¯èƒ½ç©ºé—´ä¸è¶³");
                        window.isProcessingPhotos = false;
                        return;
                    }

                    hint.textContent = `æˆåŠŸæ·»åŠ  ${processedCount} å¼ ç…§ç‰‡ï¼`;
                    setTimeout(() => hint.classList.remove('show'), 2000);

                    // æ›´æ–°ç…§ç‰‡ç®¡ç†å™¨
                    updatePhotoManager();

                    // å¦‚æœå½“å‰æ²¡æœ‰ç…§ç‰‡æ˜¾ç¤ºï¼Œç«‹å³æ˜¾ç¤ºç¬¬ä¸€å¼ ï¼Œå¹¶è‡ªåŠ¨åˆ†é…ä½ç½®
                    if (!window.currentPhotoIndex && photos.length > 0) {
                        window.currentPhotoIndex = 0;
                        // è‡ªåŠ¨ä¸ºç…§ç‰‡åˆ†é…å›ºå®šä½ç½®
                        assignPhotoPosition(0, photos.length);
                        // å»¶è¿Ÿæ‰§è¡Œï¼Œé¿å…ä¸ç³»ç»Ÿåˆå§‹åŒ–å†²çª
                        setTimeout(() => {
                            applyPhotoToScene(0, window.photoPosition);
                        }, 500);
                    }

                    window.isProcessingPhotos = false;
                });
            }
        }

        // ä¸ºç…§ç‰‡åˆ†é…å›ºå®šä½ç½®
        function assignPhotoPosition(index, totalPhotos) {
            // æ ¹æ®ç…§ç‰‡æ•°é‡å’Œç´¢å¼•åˆ†é…ä¸åŒçš„å›ºå®šä½ç½®
            const positions = [
                { x: 0, y: -15, z: 0,      name: 'åº•éƒ¨ä¸­å¤®' },
                { x: -20, y: 0, z: -10,    name: 'å·¦ä¾§' },
                { x: 20, y: 0, z: -10,     name: 'å³ä¾§' },
                { x: 0, y: 10, z: -15,     name: 'é¡¶éƒ¨' },
                { x: -15, y: -5, z: 15,    name: 'å·¦å' },
                { x: 15, y: -5, z: 15,     name: 'å³å' },
                { x: 0, y: 0, z: -25,      name: 'å‰æ–¹' },
                { x: -10, y: 8, z: 5,      name: 'å·¦ä¸Š' },
                { x: 10, y: 8, z: 5,       name: 'å³ä¸Š' }
            ];

            // ä¸ºå½“å‰ç…§ç‰‡é€‰æ‹©ä¸€ä¸ªä½ç½®ï¼ˆå¾ªç¯ä½¿ç”¨ï¼‰
            window.photoPosition = positions[index % positions.length];
            showHint(`ç…§ç‰‡ ${index + 1} åˆ†é…åˆ°: ${window.photoPosition.name}`);
        }

        // å‹ç¼©å›¾ç‰‡å¹¶è½¬æ¢ä¸ºBase64
        function compressImage(file) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        
                        // é™åˆ¶æœ€å¤§å°ºå¯¸ï¼Œé¿å…å­˜å‚¨è¿‡å¤§æ•°æ®
                        const maxWidth = 800;
                        const maxHeight = 800;
                        let width = img.width;
                        let height = img.height;
                        
                        if (width > maxWidth || height > maxHeight) {
                            const ratio = Math.min(maxWidth / width, maxHeight / height);
                            width *= ratio;
                            height *= ratio;
                        }
                        
                        canvas.width = width;
                        canvas.height = height;
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        // è½¬æ¢ä¸ºJPEGï¼Œè´¨é‡0.8
                        const compressed = canvas.toDataURL('image/jpeg', 0.8);
                        resolve(compressed);
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            });
        }

        // æ›´æ–°ç…§ç‰‡ç®¡ç†å™¨UI
        function updatePhotoManager() {
            const grid = document.getElementById('photo-grid');
            const photos = JSON.parse(localStorage.getItem('webAR_photos') || '[]');
            
            if (photos.length === 0) {
                grid.innerHTML = '<div style="color:#888; text-align:center; padding:40px;">æš‚æ— ç…§ç‰‡<br><small style="opacity:0.6;">è¯·ä¸Šä¼ ç…§ç‰‡ä»¥æ˜¾ç¤ºåœ¨3Dåœºæ™¯ä¸­</small></div>';
                return;
            }

            grid.innerHTML = '';
            photos.forEach((photo, index) => {
                const item = document.createElement('div');
                item.className = 'photo-item';
                item.innerHTML = `
                    <img src="${photo.data}" class="photo-thumb" alt="ç…§ç‰‡${index + 1}">
                    <div class="delete-x" onclick="deletePhoto(${index})">Ã—</div>
                `;
                item.onclick = (e) => {
                    if (!e.target.classList.contains('delete-x')) {
                        window.currentPhotoIndex = index;
                        applyPhotoToScene(index);
                        closeDeleteManager();
                        showHint(`å·²åˆ‡æ¢åˆ°ç…§ç‰‡ ${index + 1}`);
                    }
                };
                grid.appendChild(item);
            });
        }

        // åˆ é™¤æŒ‡å®šç…§ç‰‡
        window.deletePhoto = function(index) {
            const photos = JSON.parse(localStorage.getItem('webAR_photos') || '[]');
            if (index >= 0 && index < photos.length) {
                photos.splice(index, 1);
                localStorage.setItem('webAR_photos', JSON.stringify(photos));
                updatePhotoManager();
                
                // å¦‚æœåˆ é™¤çš„æ˜¯å½“å‰æ˜¾ç¤ºçš„ç…§ç‰‡ï¼Œæ›´æ–°å½“å‰ç´¢å¼•
                if (window.currentPhotoIndex === index) {
                    window.currentPhotoIndex = 0;
                    if (photos.length > 0) {
                        applyPhotoToScene(0);
                    } else {
                        removePhotoFromScene();
                    }
                } else if (window.currentPhotoIndex > index) {
                    window.currentPhotoIndex--;
                }
            }
        };

        // æ¸…ç©ºæ‰€æœ‰ç…§ç‰‡
        window.clearAllPhotos = function() {
            if (confirm("ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰ç…§ç‰‡å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚")) {
                localStorage.removeItem('webAR_photos');
                window.currentPhotoIndex = 0;
                removePhotoFromScene();
                closeDeleteManager();
                showHint("æ‰€æœ‰ç…§ç‰‡å·²æ¸…ç©º");
            }
        };

        // ç…§ç‰‡åˆ‡æ¢åŠŸèƒ½ - å®Œæ•´å®ç°
        window.cycleNextPhoto = function() {
            const photos = JSON.parse(localStorage.getItem('webAR_photos') || '[]');
            if (photos.length === 0) {
                showHint("è¯·å…ˆä¸Šä¼ ç…§ç‰‡");
                return;
            }

            if (window.currentPhotoIndex === undefined) {
                window.currentPhotoIndex = 0;
            } else {
                window.currentPhotoIndex = (window.currentPhotoIndex + 1) % photos.length;
            }

            applyPhotoToScene(window.currentPhotoIndex);
            showHint(`ç…§ç‰‡ ${window.currentPhotoIndex + 1} / ${photos.length}`);
        };

        // åœ¨3Dåœºæ™¯ä¸­æ˜¾ç¤ºç…§ç‰‡ - ç®€åŒ–ç‰ˆæœ¬ï¼Œç¡®ä¿ç¨³å®šæ€§
        async function applyPhotoToScene(index, position = null) {
            // å®‰å…¨æ£€æŸ¥ï¼šé˜²æ­¢é¢‘ç¹è°ƒç”¨
            if (window.isApplyingPhoto) {
                showHint("è¯·ç­‰å¾…å½“å‰ç…§ç‰‡åŠ è½½å®Œæˆ");
                return;
            }
            
            const photos = JSON.parse(localStorage.getItem('webAR_photos') || '[]');
            if (index < 0 || index >= photos.length) return;

            window.isApplyingPhoto = true;
            
            // ç§»é™¤ç°æœ‰ç…§ç‰‡
            removePhotoFromScene();
            showHint("æ­£åœ¨åŠ è½½ç…§ç‰‡...");

            // å¦‚æœæ²¡æœ‰æŒ‡å®šä½ç½®ï¼Œè‡ªåŠ¨åˆ†é…
            if (!position) {
                assignPhotoPosition(index, photos.length);
                position = window.photoPosition;
            }

            try {
                // åˆ›å»ºå›¾ç‰‡çº¹ç†
                const textureLoader = new THREE.TextureLoader();
                const texture = await new Promise((resolve, reject) => {
                    textureLoader.load(photos[index].data, resolve, undefined, reject);
                });

                // ç®€åŒ–ï¼šåˆ›å»ºä¸€ä¸ªåŸºäºå›¾ç‰‡çš„å¹³é¢å‡ ä½•ä½“ï¼Œè€Œä¸æ˜¯å¤æ‚çš„ç²’å­ç³»ç»Ÿ
                const img = new Image();
                img.src = photos[index].data;
                await new Promise((resolve) => { img.onload = resolve; img.onerror = resolve; });

                // è®¡ç®—å›¾ç‰‡æ¯”ä¾‹
                const aspectRatio = img.width / img.height;
                const width = 8;  // åŸºç¡€å®½åº¦
                const height = width / aspectRatio;  // ä¿æŒæ¯”ä¾‹

                // åˆ›å»ºå¹³é¢å‡ ä½•ä½“
                const geometry = new THREE.PlaneGeometry(width, height);
                
                // åˆ›å»ºæè´¨
                const material = new THREE.MeshBasicMaterial({
                    map: texture,
                    transparent: true,
                    opacity: 0.6,
                    side: THREE.DoubleSide
                });

                const photoMesh = new THREE.Mesh(geometry, material);
                photoMesh.name = `AR_Photo_${index}`;

                // æ ¹æ®ä½ç½®è®¾ç½®3Dåæ ‡å’Œæ—‹è½¬
                let posX = position.x;
                let posY = position.y;
                let posZ = position.z;
                let rotationX = 0, rotationY = 0, rotationZ = 0;

                // æ ¹æ®ä½ç½®è°ƒæ•´æœå‘ï¼Œç¡®ä¿ç…§ç‰‡æ­£é¢æœå‘åœºæ™¯ä¸­å¿ƒ
                if (position.name.includes('åº•éƒ¨')) {
                    // åº•éƒ¨ï¼šæœä¸Š
                    posY = position.y + height / 2;
                    rotationX = Math.PI / 2; // æ—‹è½¬90åº¦ï¼Œæœä¸Š
                } else if (position.name.includes('é¡¶éƒ¨')) {
                    // é¡¶éƒ¨ï¼šæœä¸‹
                    posY = position.y - height / 2;
                    rotationX = -Math.PI / 2; // æ—‹è½¬-90åº¦ï¼Œæœä¸‹
                } else if (position.name.includes('å·¦ä¾§')) {
                    // å·¦ä¾§ï¼šæœå³
                    posX = position.x + width / 2;
                    rotationY = Math.PI / 2; // æ—‹è½¬90åº¦ï¼Œæœå³
                } else if (position.name.includes('å³ä¾§')) {
                    // å³ä¾§ï¼šæœå·¦
                    posX = position.x - width / 2;
                    rotationY = -Math.PI / 2; // æ—‹è½¬-90åº¦ï¼Œæœå·¦
                } else if (position.name.includes('å‰æ–¹')) {
                    // å‰æ–¹ï¼šæœå‰
                    posZ = position.z + 0.1; // ç¨å¾®å‘å‰åç§»
                } else if (position.name.includes('å')) {
                    // åæ–¹ï¼šæœå
                    posZ = position.z - 0.1;
                    rotationY = Math.PI; // æ—‹è½¬180åº¦ï¼Œæœå
                } else if (position.name.includes('å·¦ä¸Š') || position.name.includes('å³ä¸Š')) {
                    // ä¸Šæ–¹ä½ç½®ï¼šè½»å¾®æœå‘ä¸­å¿ƒ
                    rotationX = Math.PI / 8;
                }

                // è®¾ç½®ä½ç½®å’Œæ—‹è½¬
                photoMesh.position.set(posX, posY, posZ);
                photoMesh.rotation.set(rotationX, rotationY, rotationZ);

                // æ·»åŠ åˆ°åœºæ™¯
                scene.add(photoMesh);
                
                showHint(`ç…§ç‰‡ ${index + 1} æ”¾ç½®åœ¨: ${position.name}`);

            } catch (error) {
                console.error("ç…§ç‰‡åŠ è½½å¤±è´¥:", error);
                showHint("ç…§ç‰‡åŠ è½½å¤±è´¥");
            } finally {
                window.isApplyingPhoto = false;
            }
        }

        // ç§»é™¤åœºæ™¯ä¸­çš„ç…§ç‰‡ï¼ˆç»Ÿä¸€å¤„ç†ï¼‰- é€‚é…æ–°çš„å¹³é¢å‡ ä½•ä½“
        function removePhotoFromScene() {
            const objectsToRemove = [];
            scene.traverse((obj) => {
                if (obj.name && obj.name.startsWith('AR_Photo_')) {
                    objectsToRemove.push(obj);
                    if (obj.material) {
                        if (obj.material.map) obj.material.map.dispose();
                        obj.material.dispose();
                    }
                    if (obj.geometry) {
                        obj.geometry.dispose();
                    }
                }
            });
            objectsToRemove.forEach(obj => scene.remove(obj));
        }


        // é€šç”¨æç¤ºæ˜¾ç¤ºå‡½æ•°
        function showHint(message) {
            const hint = document.getElementById('gesture-hint');
            hint.textContent = message;
            hint.classList.add('show');
            setTimeout(() => hint.classList.remove('show'), 2000);
        }

        // å¿«æ·é”®è®¾ç½®
        function setupKeyboardShortcuts() {
            window.addEventListener('keydown', (e) => {
                // åªåœ¨è¾“å…¥æ¡†å¤–å“åº”å¿«æ·é”®
                if (e.target.tagName === 'INPUT' || e.target.tagName === 'SELECT' || e.target.tagName === 'TEXTAREA') return;
                
                const key = e.key.toLowerCase();
                const code = e.code;
                
                switch(key) {
                    case 'h':
                        e.preventDefault();
                        toggleUI();
                        break;
                    case 'z':
                        e.preventDefault();
                        cycleNextPhoto();
                        break;
                    case 'c':
                        e.preventDefault();
                        toggleCameraDisplay();
                        break;
                }

                if (code === 'Space') {
                    e.preventDefault();
                    resetRotation();
                }

                // æ–¹å‘é”®
                if (code === 'ArrowUp') {
                    e.preventDefault();
                    startRotate('up');
                }
                if (code === 'ArrowDown') {
                    e.preventDefault();
                    startRotate('down');
                }
                if (code === 'ArrowLeft') {
                    e.preventDefault();
                    startRotate('left');
                }
                if (code === 'ArrowRight') {
                    e.preventDefault();
                    startRotate('right');
                }
            });

            window.addEventListener('keyup', (e) => {
                const code = e.code;
                if (['ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight'].includes(code)) {
                    stopRotate();
                }
            });
        }

        // ==========================================
        // 6. å¯åŠ¨æµç¨‹
        // ==========================================
        let startupTriggered = false;

        async function startApplication() {
            if (startupTriggered) return;
            startupTriggered = true;

            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            const loaderEl = document.getElementById('loader');
            if (loaderEl) {
                loaderEl.innerHTML = '<div class="spinner"></div><div class="loader-text">INITIALIZING</div>';
            }

            // æ·»åŠ å¤‡ç”¨éšè—æœºåˆ¶ï¼š15ç§’åå¼ºåˆ¶éšè—åŠ è½½ç•Œé¢
            const backupHideTimer = setTimeout(() => {
                if (loaderEl && loaderEl.style.display !== 'none') {
                    console.log('ğŸ”§ å¤‡ç”¨æœºåˆ¶ï¼š15ç§’åå¼ºåˆ¶éšè—åŠ è½½ç•Œé¢');
                    loaderEl.style.opacity = '0';
                    setTimeout(() => {
                        if (loaderEl) {
                            loaderEl.style.display = 'none';
                            console.log('âœ… åŠ è½½ç•Œé¢å·²é€šè¿‡å¤‡ç”¨æœºåˆ¶éšè—');
                        }
                    }, 500);
                }
            }, 15000);

            try {
                // 1. æ£€æŸ¥å®‰å…¨ä¸Šä¸‹æ–‡
                const isSecure = checkSecurityContext();
                if (!isSecure) {
                    console.warn('å®‰å…¨ä¸Šä¸‹æ–‡æ£€æŸ¥å¤±è´¥ï¼Œä½†å°è¯•ç»§ç»­...');
                }

                // 2. é¢„è¯·æ±‚æ‘„åƒå¤´æƒé™
                await requestCameraPermission();

                // 3. åˆå§‹åŒ–MediaPipe
                await initializeMediaPipe();

                // 4. å¯åŠ¨3Dæ¸²æŸ“å¾ªç¯ï¼ˆç«‹å³å¯åŠ¨ï¼Œä¸è¦ç­‰å¾…æ‘„åƒå¤´é¢„è§ˆï¼‰
                animate();

                // 5. åˆå§‹åŒ–æ–‡ä»¶ä¸Šä¼ å’Œå¿«æ·é”®
                setupFileUpload();
                setupKeyboardShortcuts();

                // 6. å¯åŠ¨æ‘„åƒå¤´é¢„è§ˆï¼ˆåœ¨åå°è¿è¡Œï¼Œä¸å½±å“3Dæ¸²æŸ“ï¼‰
                renderWebcamPreview();

                // æ˜¾ç¤ºåˆå§‹æç¤º
                const hint = document.getElementById('gesture-hint');
                if (hint) {
                    hint.textContent = "ç³»ç»Ÿå°±ç»ª - è¯·å°è¯•æ‰‹åŠ¿æ§åˆ¶";
                    hint.classList.add('show');
                    setTimeout(() => hint.classList.remove('show'), 3000);
                }

                // å¯åŠ¨ç³»ç»Ÿå¥åº·ç›‘æ§
                startHealthMonitoring();

                // æ¸…ç†å¤‡ç”¨è®¡æ—¶å™¨ï¼ˆå¦‚æœå·²ç»éšè—ï¼‰
                setTimeout(() => clearTimeout(backupHideTimer), 0);

            } catch (error) {
                console.error('å¯åŠ¨å¤±è´¥:', error);
                // æ¸…ç†å¤‡ç”¨è®¡æ—¶å™¨
                clearTimeout(backupHideTimer);
                
                if (loaderEl) {
                    loaderEl.innerHTML = `<div class="loader-text" style="color:#ff4444; font-size:12px;">å¯åŠ¨å¤±è´¥<br><span style="font-size:0.8rem; color:#fff;">${error.message}</span></div>`;
                }
                
                // å¦‚æœæ˜¯æƒé™é—®é¢˜ï¼Œæä¾›è¯¦ç»†å¸®åŠ©
                if (error.message.includes('permission') || error.message.includes('æƒé™')) {
                    setTimeout(() => {
                        if (loaderEl) {
                            loaderEl.innerHTML = `<div class="loader-text" style="font-size:10px; line-height:1.6;">
                                æƒé™é—®é¢˜è§£å†³æ–¹æ¡ˆ:<br>
                                1. ç‚¹å‡»åœ°å€æ æ‘„åƒå¤´å›¾æ ‡<br>
                                2. é€‰æ‹©"å§‹ç»ˆå…è®¸"<br>
                                3. åˆ·æ–°é¡µé¢<br>
                                æˆ–æ£€æŸ¥æµè§ˆå™¨éšç§è®¾ç½®
                            </div>`;
                        }
                    }, 2000);
                }
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆåè‡ªåŠ¨å¯åŠ¨
        window.addEventListener('load', () => {
            // å»¶è¿Ÿä¸€å°æ®µæ—¶é—´ï¼Œè®©DOMå’Œè„šæœ¬å®Œå…¨ç¨³å®š
            setTimeout(startApplication, 100);
        });

        // ç”¨æˆ·äº¤äº’è§¦å‘ï¼ˆå¤‡ç”¨æ–¹æ¡ˆï¼‰
        document.addEventListener('click', startApplication, { once: true });

        // ç³»ç»Ÿå¥åº·ç›‘æ§
        let healthCheckInterval;
        
        function startHealthMonitoring() {
            // æ¯30ç§’æ£€æŸ¥ä¸€æ¬¡ç³»ç»Ÿå¥åº·çŠ¶æ€
            healthCheckInterval = setInterval(() => {
                try {
                    // æ£€æŸ¥å†…å­˜ä½¿ç”¨æƒ…å†µ
                    if (performance.memory) {
                        const usedMB = performance.memory.usedJSHeapSize / (1024 * 1024);
                        const totalMB = performance.memory.totalJSHeapSize / (1024 * 1024);
                        
                        if (usedMB > 200) {
                            console.warn(`âš ï¸ å†…å­˜ä½¿ç”¨è¿‡é«˜: ${usedMB.toFixed(1)}MB / ${totalMB.toFixed(1)}MB`);
                            
                            // å¦‚æœå†…å­˜ä½¿ç”¨è¿‡é«˜ï¼Œæ¸…ç†ç…§ç‰‡åœºæ™¯
                            if (window.isApplyingPhoto === false) {
                                removePhotoFromScene();
                                // å¼ºåˆ¶åƒåœ¾å›æ”¶
                                if (window.gc) window.gc();
                            }
                        }
                        
                        // æ›´æ–°è°ƒè¯•ä¿¡æ¯æ˜¾ç¤ºå†…å­˜çŠ¶æ€
                        const debugStatus = document.getElementById('debug-info');
                        if (debugStatus && debugStatus.textContent.includes('ç³»ç»Ÿè¿è¡Œæ­£å¸¸')) {
                            debugStatus.textContent = `ç³»ç»Ÿè¿è¡Œæ­£å¸¸\nå†…å­˜: ${usedMB.toFixed(1)}MB\nFPS: ç¨³å®š`;
                        }
                    }

                    // æ£€æŸ¥3Dæ¸²æŸ“å™¨çŠ¶æ€
                    if (renderer && renderer.info) {
                        const info = renderer.info;
                        if (info.render.faces > 50000) {
                            console.warn('âš ï¸ æ¸²æŸ“é¢æ•°è¿‡å¤šï¼Œå¯èƒ½å½±å“æ€§èƒ½');
                        }
                    }

                    // æ£€æŸ¥localStorageå­˜å‚¨ç©ºé—´
                    try {
                        const photos = JSON.parse(localStorage.getItem('webAR_photos') || '[]');
                        const storageSize = new Blob([JSON.stringify(photos)]).size;
                        if (storageSize > 4 * 1024 * 1024) { // 4MB
                            console.warn('âš ï¸ æœ¬åœ°å­˜å‚¨ç©ºé—´å ç”¨è¿‡å¤š');
                        }
                    } catch (e) {
                        // å¿½ç•¥æ£€æŸ¥é”™è¯¯
                    }

                } catch (error) {
                    console.error('å¥åº·æ£€æŸ¥å¤±è´¥:', error);
                }
            }, 30000);

            // é¡µé¢å¯è§æ€§å˜åŒ–æ—¶çš„å¤„ç†
            document.addEventListener('visibilitychange', () => {
                if (document.hidden) {
                    // é¡µé¢éšè—æ—¶æš‚åœèµ„æºå¯†é›†å‹æ“ä½œ
                    console.log('é¡µé¢éšè—ï¼ŒèŠ‚çœèµ„æº...');
                    if (window.isProcessingPhotos) {
                        showHint("åå°è¿è¡Œä¸­ï¼Œç…§ç‰‡å¤„ç†æš‚åœ");
                    }
                } else {
                    // é¡µé¢æ˜¾ç¤ºæ—¶æ¢å¤æ­£å¸¸
                    console.log('é¡µé¢æ˜¾ç¤ºï¼Œæ¢å¤æ­£å¸¸...');
                }
            });
        }

        // é¡µé¢å¸è½½æ—¶æ¸…ç†èµ„æº
        window.addEventListener('beforeunload', () => {
            if (debugVideoStream) {
                debugVideoStream.getTracks().forEach(track => track.stop());
            }
            if (healthCheckInterval) {
                clearInterval(healthCheckInterval);
            }
            // æ¸…ç†3Dèµ„æº
            if (window.planetMesh) {
                window.planetMesh.geometry.dispose();
                window.planetMesh.material.dispose();
            }
            if (window.ringSystem) {
                window.ringSystem.geometry.dispose();
                window.ringSystem.material.dispose();
            }
            // æ¸…ç†ç…§ç‰‡èµ„æº
            removePhotoFromScene();
        });
    </script>
</body>
</html>
