<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç²’å­ç³»ç»Ÿæ‰‹åŠ¿è¯†åˆ«æµ‹è¯•</title>
    <style>
        body {
            font-family: 'Microsoft YaHei', sans-serif;
            background: #000;
            color: #fff;
            margin: 0;
            padding: 20px;
        }
        .test-container {
            max-width: 800px;
            margin: 0 auto;
        }
        .status { 
            padding: 15px; 
            margin: 10px 0; 
            border-radius: 8px; 
            background: #1a1a1a;
            border: 1px solid #333;
        }
        .success { background: #003300; border-color: #00ff00; }
        .error { background: #330000; border-color: #ff0000; }
        .warning { background: #333300; border-color: #ffff00; }
        
        button {
            padding: 10px 20px;
            margin: 5px;
            background: #2196F3;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }
        button:hover { background: #1976D2; }
        button:disabled { background: #666; cursor: not-allowed; }
        
        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin: 15px 0;
        }
        
        video {
            width: 100%;
            max-width: 320px;
            border: 2px solid #2196F3;
            border-radius: 8px;
            margin: 10px 0;
        }
        
        .hud {
            background: rgba(0,0,0,0.8);
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
        }
        
        .gesture-display {
            font-size: 24px;
            text-align: center;
            padding: 20px;
            background: #111;
            border-radius: 8px;
            margin: 10px 0;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>ğŸ¯ ç²’å­ç³»ç»Ÿæ‰‹åŠ¿è¯†åˆ«æµ‹è¯•</h1>
        <p>æ­¤æµ‹è¯•é¡µé¢ç”¨äºéªŒè¯ç²’å­ç³»ç»Ÿçš„æ‰‹åŠ¿è¯†åˆ«åŠŸèƒ½ä¿®å¤æƒ…å†µ</p>
        
        <div id="status-area"></div>
        
        <div class="grid">
            <button id="test-cdn" onclick="testCDN()">æµ‹è¯•CDNè¿æ¥</button>
            <button id="test-camera" onclick="testCamera()">æµ‹è¯•æ‘„åƒå¤´</button>
            <button id="test-gesture" onclick="testGesture()">å¯åŠ¨æ‰‹åŠ¿è¯†åˆ«</button>
            <button id="demo-mode" onclick="startDemo()">æ¼”ç¤ºæ¨¡å¼</button>
        </div>
        
        <div id="camera-preview" style="display:none;">
            <h3>æ‘„åƒå¤´é¢„è§ˆ</h3>
            <video id="video" autoplay muted playsinline></video>
            <canvas id="canvas" style="display:none;"></canvas>
        </div>
        
        <div id="gesture-hud" class="hud" style="display:none;">
            <h3>æ‰‹åŠ¿çŠ¶æ€</h3>
            <div class="gesture-display" id="gesture-display">ç­‰å¾…æ‰‹åŠ¿...</div>
            <div id="gesture-details"></div>
        </div>
        
        <div style="margin-top: 20px; padding: 15px; background: #222; border-radius: 8px;">
            <h3>æµ‹è¯•è¯´æ˜</h3>
            <ul>
                <li>âœ… å…ˆæµ‹è¯•CDNè¿æ¥ï¼Œç¡®ä¿èƒ½ä¸‹è½½MediaPipeèµ„æº</li>
                <li>âœ… å†æµ‹è¯•æ‘„åƒå¤´æƒé™</li>
                <li>âœ… æœ€åå¯åŠ¨æ‰‹åŠ¿è¯†åˆ«</li>
                <li>ğŸ”§ å¦‚æœå¤±è´¥ï¼Œå¯ä½¿ç”¨æ¼”ç¤ºæ¨¡å¼æŸ¥çœ‹åŠŸèƒ½</li>
            </ul>
        </div>
    </div>

    <script>
        // é…ç½®
        const HANDS_PRIMARY_BASE = 'https://cdn.jsdelivr.net/npm/@mediapipe/hands@0.4.1675469240/';
        const HANDS_FALLBACK_BASE = 'https://unpkg.com/@mediapipe/hands@0.4.1675469240/';
        
        let hands = null;
        let cameraUtils = null;
        let demoTimer = null;
        let cameraStream = null;

        // æ‰‹åŠ¨å®ç°Cameraç±»ï¼ˆå› ä¸ºæµ‹è¯•é¡µé¢æ²¡æœ‰åŠ è½½camera_utilsï¼‰
        class ManualCamera {
            constructor(videoElement, config) {
                this.video = videoElement;
                this.onFrame = config.onFrame;
                this.running = false;
            }

            async start() {
                if (!cameraStream) {
                    throw new Error('è¯·å…ˆè·å–æ‘„åƒå¤´æµ');
                }
                this.video.srcObject = cameraStream;
                await new Promise(resolve => {
                    this.video.onloadedmetadata = resolve;
                });
                
                this.running = true;
                this.processFrame();
            }

            async processFrame() {
                if (!this.running) return;
                
                try {
                    if (this.video.readyState >= 2) {
                        await this.onFrame();
                    }
                } catch (error) {
                    console.warn('å¸§å¤„ç†å¤±è´¥:', error);
                }
                
                if (this.running) {
                    requestAnimationFrame(() => this.processFrame());
                }
            }

            stop() {
                this.running = false;
            }
        }
        
        // æ˜¾ç¤ºçŠ¶æ€
        function showStatus(message, type = 'normal') {
            const area = document.getElementById('status-area');
            const div = document.createElement('div');
            div.className = `status ${type}`;
            div.innerHTML = `<strong>${new Date().toLocaleTimeString()}:</strong> ${message}`;
            area.insertBefore(div, area.firstChild);
            console.log(`[${type.toUpperCase()}] ${message}`);
        }
        
        // æµ‹è¯•CDN
        async function testCDN() {
            const btn = document.getElementById('test-cdn');
            btn.disabled = true;
            btn.textContent = 'æµ‹è¯•ä¸­...';
            
            try {
                showStatus('å¼€å§‹æµ‹è¯•CDNè¿æ¥...', 'warning');
                
                // æµ‹è¯•ä¸»è¦CDN
                const testUrl = HANDS_PRIMARY_BASE + 'hands.js';
                showStatus(`å°è¯•è¿æ¥: ${testUrl}`);
                
                const response = await fetch(testUrl, { method: 'HEAD' });
                if (response.ok) {
                    showStatus('âœ… ä¸»è¦CDNè¿æ¥æˆåŠŸ (jsdelivr)', 'success');
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                // æµ‹è¯•å¤‡ç”¨CDN
                const fallbackUrl = HANDS_FALLBACK_BASE + 'hands.js';
                const response2 = await fetch(fallbackUrl, { method: 'HEAD' });
                if (response2.ok) {
                    showStatus('âœ… å¤‡ç”¨CDNè¿æ¥æˆåŠŸ (unpkg)', 'success');
                }
                
                showStatus('ğŸ‰ CDNæµ‹è¯•å…¨éƒ¨é€šè¿‡', 'success');
                
            } catch (error) {
                showStatus(`âŒ CDNæµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
                showStatus('æç¤º: è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–ä½¿ç”¨VPN', 'warning');
            } finally {
                btn.disabled = false;
                btn.textContent = 'æµ‹è¯•CDNè¿æ¥';
            }
        }
        
        // æµ‹è¯•æ‘„åƒå¤´
        async function testCamera() {
            const btn = document.getElementById('test-camera');
            btn.disabled = true;
            btn.textContent = 'æµ‹è¯•ä¸­...';
            
            try {
                showStatus('è¯·æ±‚æ‘„åƒå¤´æƒé™...', 'warning');
                
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { width: 640, height: 480 } 
                });
                
                showStatus('âœ… æ‘„åƒå¤´æƒé™è·å–æˆåŠŸ', 'success');
                
                const video = document.getElementById('video');
                video.srcObject = stream;
                
                document.getElementById('camera-preview').style.display = 'block';
                
                // ç­‰å¾…è§†é¢‘åŠ è½½
                await new Promise((resolve) => {
                    video.onloadedmetadata = resolve;
                });
                
                showStatus(`âœ… è§†é¢‘æµå°±ç»ª: ${video.videoWidth}x${video.videoHeight}`, 'success');
                
                // åœæ­¢æµ‹è¯•æµ
                stream.getTracks().forEach(track => track.stop());
                
            } catch (error) {
                showStatus(`âŒ æ‘„åƒå¤´æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
                
                if (error.name === 'NotAllowedError' || error.name === 'PermissionDeniedError') {
                    showStatus('æç¤º: è¯·åœ¨æµè§ˆå™¨è®¾ç½®ä¸­å…è®¸æ‘„åƒå¤´è®¿é—®', 'warning');
                } else if (!window.isSecureContext) {
                    showStatus('è­¦å‘Š: éHTTPSç¯å¢ƒï¼Œæ‘„åƒå¤´å¯èƒ½æ— æ³•ä½¿ç”¨', 'warning');
                }
            } finally {
                btn.disabled = false;
                btn.textContent = 'æµ‹è¯•æ‘„åƒå¤´';
            }
        }
        
        // æµ‹è¯•æ‰‹åŠ¿è¯†åˆ«
        async function testGesture() {
            const btn = document.getElementById('test-gesture');
            btn.disabled = true;
            btn.textContent = 'åˆå§‹åŒ–ä¸­...';
            
            try {
                showStatus('å¼€å§‹åˆå§‹åŒ–MediaPipe Hands...', 'warning');
                
                // æ£€æŸ¥HTTPSç¯å¢ƒ
                if (!window.isSecureContext && window.location.hostname !== 'localhost') {
                    showStatus('âš ï¸ éå®‰å…¨ç¯å¢ƒï¼ŒMediaPipeå¯èƒ½æ— æ³•å·¥ä½œ', 'warning');
                }
                
                // å°è¯•åŠ è½½Handsåº“
                await loadMediaPipeHands();
                showStatus('âœ… Handsåº“åŠ è½½æˆåŠŸ', 'success');
                
                // åˆ›å»ºHandså®ä¾‹
                hands = new Hands({
                    locateFile: (file) => `${HANDS_PRIMARY_BASE}${file}`
                });
                
                hands.setOptions({
                    maxNumHands: 1,
                    modelComplexity: 1,
                    minDetectionConfidence: 0.6,
                    minTrackingConfidence: 0.5
                });
                
                hands.onResults(onGestureResults);
                showStatus('âœ… Handså®ä¾‹åˆ›å»ºæˆåŠŸ', 'success');
                
                // å¯åŠ¨æ‘„åƒå¤´
                const video = document.getElementById('video');
                cameraStream = await navigator.mediaDevices.getUserMedia({ 
                    video: { width: 640, height: 480 } 
                });
                video.srcObject = cameraStream;
                
                await new Promise(resolve => video.onloadedmetadata = resolve);
                document.getElementById('camera-preview').style.display = 'block';
                
                // åˆ›å»ºCameraå®ä¾‹ï¼ˆä½¿ç”¨æ‰‹åŠ¨å®ç°çš„ç‰ˆæœ¬ï¼‰
                cameraUtils = new ManualCamera(video, {
                    onFrame: async () => {
                        if (hands) {
                            await hands.send({ image: video });
                        }
                    },
                    width: 640,
                    height: 480
                });
                
                await cameraUtils.start();
                showStatus('âœ… æ‰‹åŠ¿è¯†åˆ«å¯åŠ¨æˆåŠŸ', 'success');
                
                // æ˜¾ç¤ºæ‰‹åŠ¿ç•Œé¢
                document.getElementById('gesture-hud').style.display = 'block';
                showStatus('ğŸ‰ è¯·å¯¹ç€æ‘„åƒå¤´åšå‡ºæ‰‹åŠ¿', 'success');
                
                // 5ç§’åæ˜¾ç¤ºä½¿ç”¨è¯´æ˜
                setTimeout(() => {
                    showStatus('ğŸ’¡ ä½¿ç”¨è¯´æ˜: å¼ æ‰‹/æ¡æ‹³/å‰ªåˆ€æ‰‹/é£ŸæŒ‡/å¤§æ‹‡æŒ‡', 'warning');
                }, 3000);
                
            } catch (error) {
                showStatus(`âŒ æ‰‹åŠ¿è¯†åˆ«å¤±è´¥: ${error.message}`, 'error');
                showStatus('å»ºè®®: ä½¿ç”¨æ¼”ç¤ºæ¨¡å¼æŸ¥çœ‹åŠŸèƒ½', 'warning');
                
                // æä¾›æ¼”ç¤ºæ¨¡å¼æŒ‰é’®
                document.getElementById('demo-mode').style.display = 'inline-block';
            } finally {
                btn.disabled = false;
                btn.textContent = 'å¯åŠ¨æ‰‹åŠ¿è¯†åˆ«';
            }
        }
        
        // åŠ¨æ€åŠ è½½MediaPipe Hands
        function loadMediaPipeHands() {
            return new Promise((resolve, reject) => {
                if (window.Hands) {
                    resolve();
                    return;
                }
                
                // ä½¿ç”¨CDNåŠ è½½
                const script1 = document.createElement('script');
                script1.src = HANDS_PRIMARY_BASE + 'hands.js';
                script1.onload = () => {
                    if (window.Hands) resolve();
                    else reject(new Error('Handsæœªå®šä¹‰'));
                };
                script1.onerror = () => {
                    // å°è¯•å¤‡ç”¨CDN
                    const script2 = document.createElement('script');
                    script2.src = HANDS_FALLBACK_BASE + 'hands.js';
                    script2.onload = () => {
                        if (window.Hands) resolve();
                        else reject(new Error('Handsæœªå®šä¹‰'));
                    };
                    script2.onerror = () => reject(new Error('æ‰€æœ‰CDNåŠ è½½å¤±è´¥'));
                    document.head.appendChild(script2);
                };
                document.head.appendChild(script1);
            });
        }
        
        // å¤„ç†æ‰‹åŠ¿ç»“æœ
        function onGestureResults(results) {
            const display = document.getElementById('gesture-display');
            const details = document.getElementById('gesture-details');
            
            if (!results.multiHandLandmarks || results.multiHandLandmarks.length === 0) {
                display.textContent = 'æœªæ£€æµ‹åˆ°æ‰‹åŠ¿';
                display.style.color = '#666';
                return;
            }
            
            const landmarks = results.multiHandLandmarks[0];
            const gesture = classifyGesture(landmarks);
            
            if (gesture) {
                const gestureNames = {
                    open: 'ğŸ–ï¸ å¼ æ‰‹ (Open)',
                    fist: 'âœŠ æ¡æ‹³ (Fist)',
                    scissors: 'âœŒï¸ å‰ªåˆ€æ‰‹ (Scissors)',
                    point: 'â˜ï¸ é£ŸæŒ‡ (Point)',
                    thumbsUp: 'ğŸ‘ å¤§æ‹‡æŒ‡ (Thumbs Up)'
                };
                
                display.textContent = gestureNames[gesture] || gesture;
                display.style.color = '#00ff00';
                
                details.innerHTML = `
                    <div>ç½®ä¿¡åº¦: é«˜</div>
                    <div>è§¦å‘æ—¶é—´: ${new Date().toLocaleTimeString()}</div>
                `;
                
                // ç›´æ¥æ˜¾ç¤ºè¯†åˆ«ç»“æœï¼ˆæµ‹è¯•é¡µé¢ä¸éœ€è¦å®é™…åˆ‡æ¢å½¢æ€ï¼‰
                showStatus(`æ‰‹åŠ¿è¯†åˆ«: ${gestureNames[gesture]}`, 'success');
                
                // é¢å¤–æ˜¾ç¤ºåœ¨çŠ¶æ€åŒºåŸŸ
                const area = document.getElementById('status-area');
                const div = document.createElement('div');
                div.className = 'status success';
                div.innerHTML = `<strong>ğŸ‰ æ‰‹åŠ¿è¯†åˆ«æˆåŠŸ:</strong> ${gestureNames[gesture]} (${gesture})`;
                area.insertBefore(div, area.firstChild);
            }
        }
        
        // æ‰‹åŠ¿åˆ†ç±»
        function classifyGesture(landmarks) {
            const thumb = thumbExtended(landmarks);
            const index = fingerExtended(landmarks, 8, 6, 5);
            const middle = fingerExtended(landmarks, 12, 10, 9);
            const ring = fingerExtended(landmarks, 16, 14, 13);
            const pinky = fingerExtended(landmarks, 20, 18, 17);

            if (index && middle && ring && pinky && thumb) return 'open';
            if (!index && !middle && !ring && !pinky && !thumb) return 'fist';
            if (index && middle && !ring && !pinky) return 'scissors';
            if (index && !middle && !ring && !pinky && !thumb) return 'point';
            if (thumb && !index && !middle && !ring && !pinky) return 'thumbsUp';
            return null;
        }
        
        function fingerExtended(landmarks, tip, pip, mcp) {
            const tipPos = landmarks[tip];
            const pipPos = landmarks[pip];
            const mcpPos = landmarks[mcp];
            const distTipMcp = Math.hypot(tipPos.x - mcpPos.x, tipPos.y - mcpPos.y);
            const distPipMcp = Math.hypot(pipPos.x - mcpPos.x, pipPos.y - mcpPos.y);
            return distTipMcp > distPipMcp * 1.05 && tipPos.y < mcpPos.y;
        }
        
        function thumbExtended(landmarks) {
            const tip = landmarks[4];
            const mcp = landmarks[2];
            const wrist = landmarks[0];
            const distTipWrist = Math.hypot(tip.x - wrist.x, tip.y - wrist.y);
            const distMcpWrist = Math.hypot(mcp.x - wrist.x, mcp.y - wrist.y);
            return distTipWrist > distMcpWrist * 1.1;
        }
        
        // æ¼”ç¤ºæ¨¡å¼
        function startDemo() {
            const btn = document.getElementById('demo-mode');
            
            if (demoTimer) {
                clearInterval(demoTimer);
                demoTimer = null;
                btn.textContent = 'æ¼”ç¤ºæ¨¡å¼';
                showStatus('æ¼”ç¤ºæ¨¡å¼å·²åœæ­¢', 'warning');
                return;
            }
            
            showStatus('å¯åŠ¨æ¼”ç¤ºæ¨¡å¼...', 'warning');
            document.getElementById('gesture-hud').style.display = 'block';
            
            const sequence = [
                { name: 'ğŸ–ï¸ å¼ æ‰‹ (Open)', duration: 2000 },
                { name: 'âœŒï¸ å‰ªåˆ€æ‰‹ (Scissors)', duration: 2000 },
                { name: 'âœŠ æ¡æ‹³ (Fist)', duration: 2000 },
                { name: 'â˜ï¸ é£ŸæŒ‡ (Point)', duration: 2000 },
                { name: 'ğŸ‘ å¤§æ‹‡æŒ‡ (Thumbs Up)', duration: 2000 }
            ];
            
            let index = 0;
            const display = document.getElementById('gesture-display');
            
            demoTimer = setInterval(() => {
                const current = sequence[index % sequence.length];
                display.textContent = current.name;
                display.style.color = '#ffdd00';
                
                showStatus(`æ¨¡æ‹Ÿæ‰‹åŠ¿: ${current.name}`, 'warning');
                index++;
            }, 3000);
            
            btn.textContent = 'åœæ­¢æ¼”ç¤º';
            btn.style.background = '#ff5722';
        }
        
        // é¡µé¢åŠ è½½æ£€æŸ¥
        window.addEventListener('load', () => {
            showStatus('æµ‹è¯•é¡µé¢åŠ è½½å®Œæˆ', 'success');
            showStatus(`å½“å‰ç¯å¢ƒ: ${window.isSecureContext ? 'HTTPS' : 'HTTP'}`, 'warning');
            showStatus(`å½“å‰åŸŸå: ${window.location.hostname}`, 'normal');
            
            if (!navigator.mediaDevices) {
                showStatus('âŒ æµè§ˆå™¨ä¸æ”¯æŒæ‘„åƒå¤´API', 'error');
            }
            
            if (!window.fetch) {
                showStatus('âŒ æµè§ˆå™¨ä¸æ”¯æŒfetch API', 'error');
            }
        });
    </script>
</body>
</html>
