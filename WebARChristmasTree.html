<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grand Luxury Tree v17.23 - Visual Debug</title>
    <style>
        /* ================= 1. åŸºç¡€è®¾ç½® ================= */
        @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@700&family=Great+Vibes&family=Monoton&family=Abril+Fatface&family=Ma+Shan+Zheng&display=swap');

        body { margin: 0; overflow: hidden; background-color: #050505; font-family: 'Microsoft YaHei', 'Songti SC', serif; }
        #canvas-container { width: 100vw; height: 100vh; position: absolute; top: 0; left: 0; z-index: 1; }
        
        /* ================= 2. å…¨æ–°UIè®¾è®¡ç³»ç»Ÿ ================= */
        :root {
            /* è°ƒè‰²æ¿ - å¥¢ååœ£è¯ä¸»é¢˜ */
            --bg-dark: #0a0a0a;
            --bg-glass: rgba(15, 15, 20, 0.72);
            --bg-glass-hover: rgba(25, 25, 35, 0.85);
            
            --gold-primary: #d4af37;
            --gold-light: #fceea7;
            --gold-dark: #b8941f;
            --gold-glow: rgba(212, 175, 55, 0.4);
            
            --red-accent: #c41e3a;
            --green-accent: #0d5c2f;
            --white-pure: #ffffff;
            --white-dim: #b8b8b8;
            
            /* å°ºå¯¸ç³»ç»Ÿ */
            --radius-sm: 6px;
            --radius-md: 10px;
            --radius-lg: 16px;
            --radius-xl: 24px;
            
            --spacing-xs: 4px;
            --spacing-sm: 8px;
            --spacing-md: 12px;
            --spacing-lg: 16px;
            --spacing-xl: 20px;
            
            /* å¸ƒå±€ */
            --sidebar-width: 240px;
            --control-height: 36px;
            --ui-scale: 0.95;
        }

        @media screen and (max-height: 800px) { :root { --ui-scale: 0.85; } }
        @media screen and (min-width: 2000px) { :root { --ui-scale: 1.1; } }
        :fullscreen { --ui-scale: 1.0; }

        /* ç»ç’ƒæ‹Ÿæ€åŸºç¡€ */
        .glass-panel {
            background: var(--bg-glass);
            backdrop-filter: blur(16px) saturate(180%);
            -webkit-backdrop-filter: blur(16px) saturate(180%);
            border-radius: var(--radius-lg);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4), inset 0 1px 0 rgba(255, 255, 255, 0.06);
            overflow: hidden;
            box-sizing: border-box;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .glass-panel:hover {
            background: var(--bg-glass-hover);
            border-color: var(--gold-glow);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.5), 0 0 20px var(--gold-glow);
        }

        /* åŠ¨ç”»è¿‡æ¸¡ */
        #left-sidebar, #top-right-controls { 
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.4s cubic-bezier(0.4, 0, 0.2, 1); 
        }
        
        .panel-hidden { 
            transform: translateX(calc(-1 * var(--sidebar-width) - 40px)) scale(var(--ui-scale)) !important; 
            opacity: 0 !important; 
            pointer-events: none !important; 
        }
        
        .hidden { display: none !important; }

        /* ================= 3. ä¸»è¦UIå®¹å™¨ ================= */
        
        /* å³ä¸Šè§’æ§åˆ¶ç»„ */
        #top-right-controls { 
            position: absolute; 
            top: var(--spacing-lg); 
            right: var(--spacing-lg); 
            pointer-events: auto; 
            display: flex; 
            flex-direction: column; 
            gap: var(--spacing-sm); 
            align-items: flex-end; 
            z-index: 50; 
            transform: scale(var(--ui-scale));
            transform-origin: top right;
        }

        .icon-btn {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(212, 175, 55, 0.3);
            color: var(--gold-light);
            padding: var(--spacing-sm) var(--spacing-md);
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 6px;
            border-radius: var(--radius-sm);
            font-family: 'Microsoft YaHei', sans-serif;
            backdrop-filter: blur(8px);
        }

        .icon-btn:hover {
            background: rgba(212, 175, 55, 0.15);
            border-color: var(--gold-primary);
            color: var(--white-pure);
            box-shadow: 0 0 16px var(--gold-glow);
            transform: translateY(-1px);
        }

        .icon-btn:active {
            transform: translateY(0);
        }

        /* å·¦ä¾§ä¸»è¾¹æ  */
        #left-sidebar { 
            position: absolute; 
            top: var(--spacing-lg); 
            left: var(--spacing-lg); 
            width: var(--sidebar-width); 
            height: calc(100vh - var(--spacing-xl) * 2); 
            display: flex; 
            flex-direction: column; 
            gap: var(--spacing-sm); 
            z-index: 20; 
            pointer-events: none; 
            transform: scale(var(--ui-scale)); 
            transform-origin: top left; 
        }

        .scroll-content { 
            flex: 1; 
            overflow-y: auto; 
            pointer-events: auto; 
            padding: var(--spacing-sm); 
            display: flex; 
            flex-direction: column; 
            gap: var(--spacing-sm); 
            scrollbar-width: thin; 
            scrollbar-color: var(--gold-primary) transparent;
        }

        .scroll-content::-webkit-scrollbar { width: 4px; }
        .scroll-content::-webkit-scrollbar-track { background: rgba(255, 255, 255, 0.05); border-radius: 2px; }
        .scroll-content::-webkit-scrollbar-thumb { background: var(--gold-primary); border-radius: 2px; }

        /* åº•éƒ¨å·¦ä¾§é¢æ¿ - å·²ç§»é™¤ï¼ŒåŠŸèƒ½æ•´åˆåˆ°å·¦ä¾§è¾¹æ  */
        /* .bottom-left-panel { ... } */
        

        /* ================= 4. æ ‡é¢˜å’Œæ–‡å­—ç³»ç»Ÿ ================= */
        #title-container { 
            position: absolute; 
            top: 8%; 
            left: 50%; 
            transform: translateX(-50%); 
            text-align: center; 
            pointer-events: auto; 
            cursor: move; 
            z-index: 50; 
            user-select: none; 
            padding: var(--spacing-sm) var(--spacing-lg);
            background: rgba(0, 0, 0, 0.2);
            border-radius: var(--radius-lg);
            backdrop-filter: blur(4px);
            transition: all 0.3s ease;
        }

        #title-container:hover {
            background: rgba(0, 0, 0, 0.3);
            box-shadow: 0 0 20px rgba(255, 255, 255, 0.1);
        }

        .title-line { 
            margin: 2px 0; 
            transition: all 0.3s ease; 
            white-space: nowrap; 
            color: var(--gold-light); 
            text-shadow: 0 0 20px rgba(255, 255, 255, 0.3), 0 0 40px var(--gold-glow);
            letter-spacing: 2px;
            font-weight: 300;
        }

        /* ================= 5. æ ‡é¢˜å’Œåˆ†ç»„ ================= */
        .section-title { 
            font-size: 13px; 
            font-weight: 700; 
            color: var(--gold-primary); 
            text-transform: uppercase; 
            letter-spacing: 1.5px; 
            padding: var(--spacing-xs) var(--spacing-sm);
            margin: var(--spacing-sm) 0 var(--spacing-xs);
            border-left: 3px solid var(--gold-primary);
            background: linear-gradient(90deg, rgba(212, 175, 55, 0.1) 0%, transparent 100%);
            border-radius: 0 var(--radius-sm) var(--radius-sm) 0;
        }

        .subsection-title {
            font-size: 11px;
            color: var(--white-dim);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-top: var(--spacing-md);
            margin-bottom: var(--spacing-xs);
            opacity: 0.8;
            font-weight: 600;
        }

        /* ================= 6. æ§ä»¶æ ·å¼ ================= */
        
        /* è¾“å…¥æ¡† */
        .input-glass { 
            background: rgba(0, 0, 0, 0.3); 
            border: 1px solid rgba(255, 255, 255, 0.1); 
            color: var(--gold-light); 
            padding: var(--spacing-xs) var(--spacing-sm);
            font-size: 12px; 
            outline: none; 
            transition: all 0.3s ease; 
            border-radius: var(--radius-sm); 
            width: 100%; 
            box-sizing: border-box; 
            text-align: center; 
            height: var(--control-height);
            font-family: 'Microsoft YaHei', sans-serif;
        }

        .input-glass:focus { 
            border-color: var(--gold-primary); 
            background: rgba(0, 0, 0, 0.5); 
            box-shadow: 0 0 12px var(--gold-glow);
        }

        select.input-glass { 
            cursor: pointer; 
            text-align: left;
            padding-left: var(--spacing-sm);
        }

        select.input-glass option { 
            background: #1a1a1a; 
            color: var(--gold-primary); 
            font-size: 11px;
        }

        /* æ»‘å— */
        input[type=range] { 
            -webkit-appearance: none; 
            width: 100%; 
            background: transparent; 
            margin: var(--spacing-sm) 0; 
            height: var(--control-height);
        }

        input[type=range]:focus { outline: none; }

        input[type=range]::-webkit-slider-runnable-track { 
            width: 100%; 
            height: 4px; 
            cursor: pointer; 
            background: rgba(255, 255, 255, 0.15); 
            border-radius: 2px; 
            box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.5);
        }

        input[type=range]::-webkit-slider-thumb { 
            height: 16px; 
            width: 16px; 
            border-radius: 50%; 
            background: var(--gold-primary); 
            cursor: pointer; 
            -webkit-appearance: none; 
            margin-top: -6px; 
            box-shadow: 0 0 8px var(--gold-glow);
            border: 2px solid var(--bg-dark);
            transition: all 0.2s ease;
        }

        input[type=range]::-webkit-slider-thumb:hover { 
            transform: scale(1.2); 
            background: var(--gold-light);
            box-shadow: 0 0 12px var(--gold-primary);
        }

        input[type=range]::-webkit-slider-thumb:active {
            transform: scale(1.1);
        }

        /* é¢œè‰²é€‰æ‹©å™¨ */
        input[type="color"] { 
            -webkit-appearance: none; 
            border: 2px solid rgba(255, 255, 255, 0.2); 
            width: 40px; 
            height: 24px; 
            cursor: pointer; 
            padding: 0; 
            background: none; 
            border-radius: var(--radius-sm);
            transition: all 0.2s ease;
        }

        input[type="color"]:hover {
            border-color: var(--gold-primary);
            transform: scale(1.05);
        }

        /* æŒ‰é’® */
        .elegant-btn { 
            background: rgba(255, 255, 255, 0.05); 
            border: 1px solid rgba(212, 175, 55, 0.3); 
            color: var(--gold-light); 
            padding: var(--spacing-sm) var(--spacing-md);
            cursor: pointer; 
            text-transform: uppercase; 
            font-size: 11px; 
            transition: all 0.3s ease; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            border-radius: var(--radius-sm); 
            box-sizing: border-box; 
            position: relative; 
            overflow: hidden; 
            font-family: 'Microsoft YaHei', sans-serif; 
            text-decoration: none;
            font-weight: 600;
            letter-spacing: 0.5px;
            height: var(--control-height);
        }

        .elegant-btn:hover { 
            background: rgba(212, 175, 55, 0.15); 
            border-color: var(--gold-primary); 
            color: var(--white-pure); 
            box-shadow: 0 0 16px var(--gold-glow);
            transform: translateY(-1px);
        }

        .elegant-btn:active { 
            transform: translateY(0) scale(0.98); 
            box-shadow: 0 0 8px var(--gold-glow);
        }

        .elegant-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            pointer-events: none;
        }

        .elegant-btn.danger { 
            border-color: rgba(196, 30, 58, 0.5); 
            color: #ff6b7a; 
        }

        .elegant-btn.danger:hover { 
            background: rgba(196, 30, 58, 0.2); 
            border-color: var(--red-accent);
            box-shadow: 0 0 16px rgba(196, 30, 58, 0.4);
        }

        .elegant-btn.primary { 
            background: linear-gradient(135deg, rgba(212, 175, 55, 0.2), rgba(255, 215, 0, 0.1));
            border-color: var(--gold-primary);
        }

        .elegant-btn.primary:hover {
            background: linear-gradient(135deg, rgba(212, 175, 55, 0.3), rgba(255, 215, 0, 0.2));
            box-shadow: 0 0 20px var(--gold-glow);
        }

        /* ä¸Šä¼ æŒ‰é’®ç‰¹æ®Šå¤„ç† */
        .upload-btn {
            position: relative;
        }

        .upload-btn input[type="file"] { 
            position: absolute; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            opacity: 0; 
            cursor: pointer; 
        }

        /* æ§åˆ¶ç»„å®¹å™¨ */
        .control-group { 
            display: flex; 
            flex-direction: column; 
            gap: var(--spacing-xs); 
            margin-bottom: var(--spacing-sm);
            background: rgba(0, 0, 0, 0.2);
            padding: var(--spacing-sm);
            border-radius: var(--radius-sm);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .control-row { 
            display: flex; 
            flex-direction: column; 
            gap: 4px; 
            margin-bottom: var(--spacing-xs); 
        }

        .control-label { 
            color: var(--white-dim); 
            font-size: 10px; 
            font-weight: 700; 
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .control-value {
            color: var(--gold-primary);
            font-weight: 600;
        }

        /* æ»šåŠ¨å®¹å™¨ */
        .particle-scroll-container { 
            max-height: 180px; 
            overflow-y: auto; 
            padding-right: 6px; 
            margin-right: -6px; 
            border-left: 2px solid rgba(212, 175, 55, 0.15); 
            padding-left: var(--spacing-sm); 
            border-radius: var(--radius-sm);
        }

        .particle-scroll-container::-webkit-scrollbar { width: 3px; }
        .particle-scroll-container::-webkit-scrollbar-track { background: rgba(255, 255, 255, 0.03); border-radius: 2px; }
        .particle-scroll-container::-webkit-scrollbar-thumb { background: var(--gold-primary); border-radius: 2px; }

        /* ================= 7. äº¤äº’æ§åˆ¶åŒº ================= */
        
        .interaction-grid { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: var(--spacing-xs); 
            margin-bottom: var(--spacing-sm); 
        }

        .direction-pad { 
            display: grid; 
            grid-template-columns: 1fr 1fr 1fr; 
            gap: var(--spacing-xs); 
            margin-top: var(--spacing-sm); 
            padding-top: var(--spacing-sm); 
            border-top: 1px solid rgba(255, 255, 255, 0.08); 
        }

        .dir-btn { 
            background: rgba(255, 255, 255, 0.05); 
            border: 1px solid rgba(212, 175, 55, 0.2); 
            color: var(--gold-light); 
            text-align: center; 
            cursor: pointer; 
            padding: var(--spacing-sm) 0; 
            border-radius: var(--radius-sm); 
            font-size: 12px; 
            user-select: none; 
            transition: 0.2s; 
            height: var(--control-height);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .dir-btn:hover { 
            background: rgba(212, 175, 55, 0.2); 
            color: var(--white-pure); 
            box-shadow: 0 0 10px var(--gold-glow);
        }

        .dir-btn:active { 
            background: var(--gold-primary); 
            color: var(--bg-dark); 
            transform: scale(0.95);
        }

        .dir-btn.center {
            font-size: 10px;
            padding: var(--spacing-xs);
        }

        /* ================= 8. æ‘„åƒå¤´é¢„è§ˆ ================= */
        #webcam-wrapper { 
            position: absolute; 
            bottom: var(--spacing-lg); 
            right: var(--spacing-lg); 
            width: 160px; 
            height: 120px; 
            border: 2px solid var(--gold-primary); 
            border-radius: var(--radius-md); 
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.8); 
            overflow: hidden; 
            z-index: 20; 
            pointer-events: auto; 
            background: #000; 
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            transform: scale(var(--ui-scale));
            transform-origin: bottom right;
        }

        #webcam-wrapper.camera-hidden { 
            opacity: 0; 
            pointer-events: none; 
            transform: translateY(20px) scale(var(--ui-scale)); 
            border-color: rgba(212, 175, 55, 0.2);
        }

        #webcam-canvas { 
            width: 100%; 
            height: 100%; 
            object-fit: cover; 
            transform: scaleX(-1); 
            display: block; 
        }

        #cam-status { 
            position: absolute; 
            bottom: 6px; 
            right: 6px; 
            width: 8px; 
            height: 8px; 
            background: #550000; 
            border-radius: 50%; 
            box-shadow: 0 0 6px #ff0000; 
            z-index: 30; 
            transition: 0.3s; 
            border: 2px solid #000;
        }

        #cam-status.active { 
            background: #00ff00; 
            box-shadow: 0 0 10px #00ff00; 
        }

        /* ================= 9. ç…§ç‰‡ç®¡ç†å™¨ ================= */
        #delete-manager { 
            position: absolute; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: rgba(10, 10, 10, 0.92); 
            z-index: 60; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            pointer-events: auto; 
            backdrop-filter: blur(20px);
            opacity: 1;
            transition: opacity 0.3s ease;
        }

        #delete-manager.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .manager-title { 
            color: var(--gold-primary); 
            font-size: 24px; 
            font-family: 'Cinzel', serif; 
            letter-spacing: 3px; 
            margin-bottom: var(--spacing-lg);
            text-shadow: 0 0 20px var(--gold-glow);
        }

        #photo-grid { 
            display: flex; 
            flex-wrap: wrap; 
            gap: 15px; 
            width: 70%; 
            max-width: 800px;
            height: 50%; 
            overflow-y: auto; 
            justify-content: center; 
            padding: 20px; 
            border: 1px solid rgba(212, 175, 55, 0.3); 
            margin: 20px 0; 
            background: rgba(0, 0, 0, 0.5); 
            border-radius: var(--radius-lg);
            backdrop-filter: blur(8px);
        }

        .photo-item { 
            width: 90px; 
            height: 90px; 
            position: relative; 
            border: 2px solid var(--gold-primary); 
            transition: all 0.3s ease; 
            cursor: pointer; 
            border-radius: var(--radius-sm);
            overflow: hidden;
            background: #000;
        }

        .photo-item:hover { 
            transform: scale(1.1) translateY(-2px); 
            border-color: var(--gold-light); 
            box-shadow: 0 0 20px var(--gold-glow);
            z-index: 10;
        }

        .photo-thumb { 
            width: 100%; 
            height: 100%; 
            object-fit: cover; 
            display: block;
        }

        .delete-x { 
            position: absolute; 
            top: -6px; 
            right: -6px; 
            width: 22px; 
            height: 22px; 
            background: var(--red-accent); 
            color: white; 
            border-radius: 50%; 
            text-align: center; 
            line-height: 20px; 
            font-size: 14px; 
            cursor: pointer; 
            font-weight: bold; 
            border: 2px solid var(--white-pure);
            transition: all 0.2s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.5);
        }

        .delete-x:hover { 
            transform: scale(1.2) rotate(90deg); 
            background: #ff0000;
            box-shadow: 0 0 12px rgba(255, 0, 0, 0.6);
        }

        .manager-actions { 
            display: flex; 
            gap: var(--spacing-lg); 
            margin-top: var(--spacing-md);
        }

        .manager-actions .elegant-btn {
            min-width: 120px;
            font-size: 12px;
        }

        /* ================= 10. åŠ è½½å™¨å’ŒçŠ¶æ€ ================= */
        #loader { 
            position: absolute; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: var(--bg-dark); 
            z-index: 100; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            transition: opacity 0.5s ease-out; 
        }

        .spinner { 
            width: 60px; 
            height: 60px; 
            border: 2px solid rgba(212, 175, 55, 0.15); 
            border-top: 3px solid var(--gold-primary); 
            border-radius: 50%; 
            animation: spin 1.2s cubic-bezier(0.4, 0, 0.2, 1) infinite; 
            box-shadow: 0 0 20px var(--gold-glow);
        }

        @keyframes spin { 
            0% { transform: rotate(0deg) scale(1); } 
            50% { transform: rotate(180deg) scale(1.05); } 
            100% { transform: rotate(360deg) scale(1); } 
        }

        .loader-text { 
            color: var(--gold-primary); 
            font-size: 14px; 
            letter-spacing: 6px; 
            margin-top: 30px; 
            font-family: 'Cinzel', serif; 
            opacity: 0.9;
            text-transform: uppercase;
        }

        /* è¿›åº¦æ¡ */
        .progress-container {
            width: 320px;
            margin-top: 20px;
            display: none;
        }

        .progress-bar-bg {
            width: 100%;
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 10px;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.5);
        }

        .progress-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--gold-dark), var(--gold-primary), var(--gold-light));
            width: 0%;
            transition: width 0.4s ease;
            box-shadow: 0 0 16px var(--gold-glow);
            border-radius: 4px;
        }

        .progress-text {
            color: var(--gold-light);
            font-size: 12px;
            text-align: center;
            letter-spacing: 1px;
            font-weight: 600;
        }

        .progress-step {
            color: var(--white-dim);
            font-size: 11px;
            text-align: center;
            margin-top: 6px;
            letter-spacing: 0.5px;
            opacity: 0.8;
        }

        /* è°ƒè¯•ä¿¡æ¯ */
        #debug-info { 
            position: absolute; 
            bottom: 40px; 
            width: 100%; 
            text-align: center; 
            color: #00ff00;
            font-size: 13px; 
            font-weight: 600;
            font-family: 'Consolas', monospace;
            pointer-events: none; 
            z-index: 999; 
            text-shadow: 0 0 4px #000;
            background: rgba(0,0,0,0.4); 
            padding: 6px 0;
            transition: all 0.5s ease;
            letter-spacing: 0.5px;
        }

        #debug-info.loading-center {
            bottom: auto;
            top: 55%;
            transform: translateY(-50%);
            font-size: 16px;
            background: rgba(0,0,0,0.85);
            padding: 20px 0;
            border-top: 1px solid rgba(212,175,55,0.5);
            border-bottom: 1px solid rgba(212,175,55,0.5);
            border-radius: var(--radius-sm);
            max-width: 400px;
            left: 50%;
            margin-left: -200px;
            position: absolute;
            width: 400px;
        }

        .debug-hidden {
            opacity: 0 !important;
            pointer-events: none !important;
        }

        /* æ‰‹åŠ¿æç¤º */
        #gesture-hint {
            position: absolute;
            top: 16%;
            left: 50%;
            transform: translateX(-50%);
            color: var(--gold-light);
            font-size: 14px;
            font-weight: 500;
            letter-spacing: 1px;
            background: rgba(0, 0, 0, 0.4);
            padding: 8px 16px;
            border-radius: var(--radius-lg);
            backdrop-filter: blur(8px);
            border: 1px solid rgba(212, 175, 55, 0.3);
            opacity: 0;
            transition: opacity 0.5s ease;
            pointer-events: none;
            z-index: 40;
        }

        #gesture-hint.show {
            opacity: 1;
        }

        /* ================= 11. å“åº”å¼å¾®è°ƒ ================= */
        @media (max-width: 768px) {
            :root { --ui-scale: 0.8; --sidebar-width: 200px; }
            #left-sidebar { left: 10px; }
            #top-right-controls { right: 10px; }
            #webcam-wrapper { bottom: 10px; right: 10px; width: 120px; height: 90px; }
            .icon-btn { padding: 6px 10px; font-size: 11px; }
        }

        /* ================= 12. éšè—æ»šåŠ¨æ¡ä½†ä¿ç•™åŠŸèƒ½ ================= */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

    </style>
    <script type="importmap">
        { "imports": { "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js", "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/", "@mediapipe/tasks-vision": "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.3/+esm" } }
    </script>
</head>
<body>
    <!-- åŠ è½½ç•Œé¢ -->
    <div id="loader">
        <div class="spinner"></div>
        <div class="loader-text">SYSTEM INITIALIZING</div>
        <div class="progress-container" id="progress-container">
            <div class="progress-bar-bg">
                <div class="progress-bar-fill" id="progress-bar-fill"></div>
            </div>
            <div class="progress-text" id="progress-text">0%</div>
            <div class="progress-step" id="progress-step">æ­£åœ¨åˆå§‹åŒ–...</div>
        </div>
    </div>

    <!-- ä¸»ç”»å¸ƒå®¹å™¨ -->
    <div id="canvas-container"></div>

    <!-- æ ‡é¢˜åŒºåŸŸ -->
    <div id="title-container">
        <h1 id="display-line1" class="title-line">Merry</h1>
        <h1 id="display-line2" class="title-line">Christmas</h1>
    </div>

    <!-- æ‰‹åŠ¿æç¤º -->
    <div id="gesture-hint">æ­£åœ¨åˆå§‹åŒ–ç³»ç»Ÿ...</div>

    <!-- UIå›¾å±‚ -->
    <div id="ui-layer">
        <!-- å³ä¸Šè§’æ§åˆ¶ -->
        <div id="top-right-controls">
            <button class="icon-btn glass-panel" id="fs-btn" onclick="toggleFullScreen()">
                <span>â›¶</span> <span>å…¨å±æ˜¾ç¤º</span>
            </button>
            <button class="icon-btn glass-panel" id="toggle-ui-btn" onclick="toggleUI()">
                <span>ğŸ‘</span> <span>éšè—ç•Œé¢</span>
            </button>
        </div>

        <!-- å·¦ä¾§ä¸»è¾¹æ  -->
        <div id="left-sidebar">
            <!-- åœºæ™¯å®šåˆ¶ -->
            <div class="glass-panel scroll-content">
                
                <div class="section-title">åœºæ™¯å®šåˆ¶</div>

                <!-- ç¥ç¦è¯­å½• -->
                <div class="subsection-title">ç¥ç¦è¯­å½•</div>
                <div class="control-group">
                    <input type="text" id="input-line1" class="input-glass" placeholder="ç¬¬ä¸€è¡Œæ–‡å­—" oninput="updateTextConfig()">
                    <input type="text" id="input-line2" class="input-glass" placeholder="ç¬¬äºŒè¡Œæ–‡å­—" oninput="updateTextConfig()">
                </div>

                <!-- å­—ä½“é£æ ¼ -->
                <div class="subsection-title">å­—ä½“é£æ ¼</div>
                <select id="font-select" class="input-glass" onchange="updateTextConfig()">
                    <option value="style1">ğŸ–Šï¸ ä¹¦æ³•éŸµå‘³</option>
                    <option value="style2">ğŸ›ï¸ å¤å…¸è¡¬çº¿</option>
                    <option value="style3">âœï¸ ä¼˜é›…æ‰‹å†™</option>
                    <option value="style4">ğŸ¨ è‰ºæœ¯çº¿æ¡</option>
                    <option value="style5">ğŸ“° å¤å¤é‡ç£…</option>
                </select>

                <!-- å¤§å°å’Œé¢œè‰² -->
                <div class="subsection-title">å¤–è§‚è°ƒèŠ‚</div>
                <div class="control-group">
                    <div class="control-row">
                        <label class="control-label">
                            å­—ä½“å¤§å° <span class="control-value" id="size-value">100</span>
                        </label>
                        <input type="range" min="50" max="250" value="100" id="slider-fontsize" oninput="updateTextConfig()">
                    </div>
                    <div style="display: flex; gap: 8px; align-items: center; justify-content: space-between; margin-top: 4px;">
                        <span class="control-label" style="margin: 0;">æ–‡å­—é¢œè‰²</span>
                        <input type="color" id="color-picker" value="#fceea7" oninput="updateTextConfig()">
                    </div>
                </div>

                <!-- èƒŒæ™¯éŸ³ä¹ -->
                <div class="subsection-title">èƒŒæ™¯éŸ³ä¹</div>
                <div class="control-group">
                    <div style="display: flex; gap: 8px; margin-bottom: 4px;">
                        <button class="elegant-btn" onclick="toggleMusicPlay()" id="play-btn" style="flex: 2;">
                            <span id="play-icon">â¯</span> <span id="play-text">æ’­æ”¾</span>
                        </button>
                        <button class="elegant-btn" onclick="replayMusic()" style="flex: 1;" title="é‡æ–°æ’­æ”¾">
                            âŸ²
                        </button>
                    </div>
                    <div class="control-row">
                        <label class="control-label">
                            éŸ³é‡è°ƒèŠ‚ <span class="control-value" id="volume-value">50</span>
                        </label>
                        <input type="range" min="0" max="100" value="50" id="slider-volume" oninput="updateVolume(this.value)">
                    </div>
                    <label class="elegant-btn upload-btn" id="music-upload-label" style="margin-top: 4px;">
                        <span>â™« ä¸Šä¼ éŸ³ä¹</span>
                        <input type="file" id="music-input" accept=".mp3,audio/mpeg">
                    </label>
                </div>

                <!-- ç²’å­æ§åˆ¶ -->
                <div class="subsection-title">ç²’å­æ§åˆ¶</div>
                <div class="particle-scroll-container">
                    <div class="control-group">
                        <div class="control-row">
                            <label class="control-label">
                                è£…é¥°å¯†åº¦ (æ ‘) <span class="control-value" id="tree-value">1500</span>
                            </label>
                            <input type="range" min="500" max="3000" value="1500" id="slider-tree" oninput="document.getElementById('tree-value').textContent=this.value">
                        </div>
                        <div class="control-row">
                            <label class="control-label">
                                æ˜Ÿå°˜å¯†åº¦ (èƒŒæ™¯) <span class="control-value" id="dust-value">2500</span>
                            </label>
                            <input type="range" min="500" max="5000" value="2500" id="slider-dust" oninput="document.getElementById('dust-value').textContent=this.value">
                        </div>
                    </div>

                    <div class="control-group">
                        <div class="control-row">
                            <label class="control-label">
                                é›ªèŠ±æ•°é‡ <span class="control-value" id="snow-count-value">1500</span>
                            </label>
                            <input type="range" min="0" max="3000" step="100" value="1500" id="slider-snow-count" onchange="updateSnowSettings()">
                        </div>
                        <div class="control-row">
                            <label class="control-label">
                                é›ªèŠ±å¤§å° <span class="control-value" id="snow-size-value">0.12</span>
                            </label>
                            <input type="range" min="0.05" max="0.3" step="0.01" value="0.12" id="slider-snow-size" onchange="updateSnowSettings()">
                        </div>
                        <div class="control-row">
                            <label class="control-label">
                                ä¸‹è½é€Ÿåº¦ <span class="control-value" id="snow-speed-value">3.5</span>
                            </label>
                            <input type="range" min="1.0" max="8.0" step="0.5" value="3.5" id="slider-snow-speed" oninput="updateSnowSpeed(this.value)">
                        </div>
                    </div>
                </div>

                <button class="elegant-btn primary" style="width: 100%; margin-top: 8px;" onclick="applyParticleSettings()">
                    âš¡ é‡ç½®åœºæ™¯
                </button>

                <!-- äº¤äº’ä¸­æ§ -->
                <div class="section-title" style="margin-top: 16px;">äº¤äº’ä¸­æ§</div>

                <div class="subsection-title">å½¢æ€åˆ‡æ¢</div>
                <div class="interaction-grid">
                    <button class="elegant-btn primary" onclick="setMode('TREE')">
                        <span>èšåˆ</span>
                    </button>
                    <button class="elegant-btn" onclick="cycleNextPhoto()">
                        <span>æŠ“å–ç…§ç‰‡</span>
                    </button>
                </div>

                <div class="subsection-title">æ‰‹åŠ¨æ§åˆ¶</div>
                <div class="control-group">
                    <div class="control-row">
                        <label class="control-label">
                            æ—‹è½¬é€Ÿåº¦ <span class="control-value" id="rotation-value">1.4</span>
                        </label>
                        <input type="range" min="0.1" max="5.0" step="0.1" value="1.4" oninput="updateRotationSpeed(this.value)">
                    </div>
                    
                    <div class="direction-pad">
                        <div></div>
                        <div class="dir-btn" onmousedown="startRotate('up')" onmouseup="stopRotate()" onmouseleave="stopRotate()">â–²</div>
                        <div></div>
                        <div class="dir-btn" onmousedown="startRotate('left')" onmouseup="stopRotate()" onmouseleave="stopRotate()">â—€</div>
                        <div class="dir-btn center" onclick="resetRotation()" title="é‡ç½®æ—‹è½¬">â—</div>
                        <div class="dir-btn" onmousedown="startRotate('right')" onmouseup="stopRotate()" onmouseleave="stopRotate()">â–¶</div>
                        <div></div>
                        <div class="dir-btn" onmousedown="startRotate('down')" onmouseup="stopRotate()" onmouseleave="stopRotate()">â–¼</div>
                        <div></div>
                    </div>
                </div>

                <!-- èµ„æºç®¡ç† -->
                <div class="section-title" style="margin-top: 16px;">èµ„æºç®¡ç†</div>

                <div class="subsection-title">ç…§ç‰‡ç®¡ç†</div>
                <div class="control-group">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 6px;">
                        <label class="elegant-btn upload-btn">
                            <span>+ ä¸Šä¼ ç…§ç‰‡</span>
                            <input type="file" id="file-input" multiple accept="image/*">
                        </label>
                        <button class="elegant-btn" onclick="openDeleteManager()">
                            <span>ç®¡ç†ç…§ç‰‡</span>
                        </button>
                    </div>
                </div>

                <div class="subsection-title">æ‘„åƒå¤´æ§åˆ¶</div>
                <div class="control-group">
                    <button class="elegant-btn" id="toggle-cam-btn" onclick="toggleCameraDisplay()">
                        <span>ğŸ“· éšè—/æ˜¾ç¤ºç”»é¢</span>
                    </button>
                </div>

                <!-- ç»Ÿè®¡ä¿¡æ¯ -->
                <div class="subsection-title">ç³»ç»Ÿä¿¡æ¯</div>
                <div style="text-align: center; font-size: 10px; color: #888; padding: 8px; background: rgba(0,0,0,0.2); border-radius: 6px; border: 1px solid rgba(255,255,255,0.05);">
                    <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
                    <span id="busuanzi_container_site_pv">
                        äººæ°”å€¼: <span id="busuanzi_value_site_pv" style="color: var(--gold-primary); font-weight: bold;">--</span> ğŸ”¥
                    </span>
                </div>
            </div>
        </div>

        <!-- åº•éƒ¨èµ„æºç®¡ç†é¢æ¿ (ç§»é™¤ï¼ŒåŠŸèƒ½å·²æ•´åˆåˆ°å·¦ä¾§) -->
        <!-- <div class="bottom-left-panel glass-panel"> ... </div> -->

        <!-- è°ƒè¯•ä¿¡æ¯ -->
        <div id="debug-info" class="loading-center">æ­£åœ¨ä¸‹è½½æ‰‹åŠ¿è¯†åˆ«æ¨¡å‹...</div>
    </div>

    <!-- æ‘„åƒå¤´é¢„è§ˆ -->
    <div id="webcam-wrapper">
        <canvas id="webcam-canvas" width="320" height="240"></canvas>
        <div id="cam-status"></div>
    </div>
    <video id="webcam-video" autoplay playsinline muted style="display:none"></video>

    <!-- ç…§ç‰‡ç®¡ç†å™¨ -->
    <div id="delete-manager" class="hidden">
        <div class="manager-title">ç…§ç‰‡åº“ç®¡ç†</div>
        <div id="photo-grid"></div>
        <div class="manager-actions">
            <button class="elegant-btn danger glass-panel" onclick="clearAllPhotos()">
                æ¸…ç©ºæ‰€æœ‰
            </button>
            <button class="elegant-btn glass-panel" onclick="closeDeleteManager()">
                å…³é—­
            </button>
        </div>
    </div>

    <script type="module">
        import * as THREE from 'three';
        import { EffectComposer } from 'three/addons/postprocessing/EffectComposer.js';
        import { RenderPass } from 'three/addons/postprocessing/RenderPass.js';
        import { UnrealBloomPass } from 'three/addons/postprocessing/UnrealBloomPass.js';
        import { RoomEnvironment } from 'three/addons/environments/RoomEnvironment.js'; 
        import { FilesetResolver, HandLandmarker, DrawingUtils } from '@mediapipe/tasks-vision';

        const DB_NAME = "GrandTreeDB_v17_Clean"; 
        const EXPORTED_DATA = null;

        let CONFIG = {
            colors: { bg: 0x000000, champagneGold: 0xffd966, deepGreen: 0x03180a, accentRed: 0x990000 },
            particles: { count: 1500, dustCount: 2500, treeHeight: 24, treeRadius: 8 },
            snow: { count: 1500, range: 70, speed: 3.5, sizeBase: 0.12, sizeVar: 0.1 }, 
            camera: { z: 50 },
            interaction: { rotationSpeed: 1.4, grabRadius: 0.25 }
        };

        const STATE = { mode: 'TREE', focusTarget: null, focusType: 0, hand: { detected: false, x: 0, y: 0 }, rotation: { x: 0, y: 0 }, uiVisible: true, cameraVisible: true };
        let manualRotateState = { x: 0, y: 0 };
        let currentPhotoIndex = -1;
        let isAnimating = false;
        
        const INPUTS = { z: false, space: false, handOpen: false, handFist: false };
        let gestureLossTimer = null; 

        const FONT_STYLES = { 'style1': { font: "'Ma Shan Zheng', cursive", spacing: "4px", shadow: "2px 2px 8px rgba(180,50,50,0.8)", transform: "none" }, 'style2': { font: "'Cinzel', serif", spacing: "6px", shadow: "0 0 20px rgba(255,215,0,0.5)", transform: "none" }, 'style3': { font: "'Great Vibes', cursive", spacing: "1px", shadow: "0 0 15px rgba(255,200,255,0.7)", transform: "none" }, 'style4': { font: "'Monoton', cursive", spacing: "1px", shadow: "0 0 10px #fff", transform: "none" }, 'style5': { font: "'Abril Fatface', cursive", spacing: "0px", shadow: "0 5px 15px rgba(0,0,0,0.8)", transform: "none" } };

        let db;
        function initDB() { if(EXPORTED_DATA) return Promise.resolve(null); return new Promise(r=>{const q=indexedDB.open(DB_NAME,1);q.onupgradeneeded=e=>{const d=e.target.result;if(!d.objectStoreNames.contains('photos'))d.createObjectStore('photos',{keyPath:"id"});if(!d.objectStoreNames.contains('music'))d.createObjectStore('music',{keyPath:"id"})};q.onsuccess=e=>{db=e.target.result;r(db)};q.onerror=()=>r(null)}); }
        function savePhotoToDB(b){if(!db)return null;const t=db.transaction('photos',"readwrite");const i=Date.now()+Math.random().toString();t.objectStore('photos').add({id:i,data:b});return i;}
        function loadPhotosFromDB(){if(EXPORTED_DATA) return Promise.resolve(EXPORTED_DATA.photos || []); if(!db)return Promise.resolve([]); return new Promise(r=>{db.transaction('photos',"readonly").objectStore('photos').getAll().onsuccess=e=>r(e.target.result)}); }
        function deletePhotoFromDB(i){if(db)db.transaction('photos',"readwrite").objectStore('photos').delete(i);}
        function clearPhotosDB(){if(db)db.transaction('photos',"readwrite").objectStore('photos').clear();}
        function saveMusicToDB(b){if(!db)return;const t=db.transaction('music',"readwrite");t.objectStore('music').put({id:'bgm',data:b});}
        function loadMusicFromDB(){if(EXPORTED_DATA && EXPORTED_DATA.music) return Promise.resolve(dataURLtoBlob(EXPORTED_DATA.music)); if(!db)return Promise.resolve(null);return new Promise(r=>{db.transaction('music',"readonly").objectStore('music').get('bgm').onsuccess=e=>r(e.target.result?e.target.result.data:null)}); }
        function dataURLtoBlob(dataurl) { var arr = dataurl.split(','), mime = arr[0].match(/:(.*?);/)[1], bstr = atob(arr[1]), n = bstr.length, u8arr = new Uint8Array(n); while(n--){ u8arr[n] = bstr.charCodeAt(n); } return new Blob([u8arr], {type:mime}); }

        let scene, camera, renderer, composer, mainGroup, particleSystem=[], photoMeshGroup=new THREE.Group(), snowInstancedMesh, snowDummy=new THREE.Object3D(), snowData=[], clock=new THREE.Clock(), handLandmarker, videoElement, caneTexture, bgmAudio=new Audio(); bgmAudio.loop=true; let isMusicPlaying=false;
        
        // è¿›åº¦ç®¡ç†å™¨ (ä¿æŒåŸæœ‰é€»è¾‘ï¼ŒUIå·²æ›´æ–°)
        const progressManager = {
            totalSteps: 8,
            currentStep: 0,
            container: null,
            barFill: null,
            text: null,
            stepText: null,
            
            init() {
                this.container = document.getElementById('progress-container');
                this.barFill = document.getElementById('progress-bar-fill');
                this.text = document.getElementById('progress-text');
                this.stepText = document.getElementById('progress-step');
                this.currentStep = 0;
                if(this.container) this.container.style.display = 'block';
                this.update(0, 'å¼€å§‹åˆå§‹åŒ–...');
            },
            
            update(step, message) {
                this.currentStep = step;
                const percentage = Math.round((step / this.totalSteps) * 100);
                
                if(this.barFill) this.barFill.style.width = percentage + '%';
                if(this.text) this.text.textContent = percentage + '%';
                if(this.stepText) this.stepText.textContent = message;
            },
            
            next(message) {
                this.currentStep++;
                this.update(this.currentStep, message);
            },
            
            complete() {
                if(this.container) {
                    this.update(this.totalSteps, 'åˆå§‹åŒ–å®Œæˆï¼');
                    setTimeout(() => {
                        this.container.style.display = 'none';
                    }, 500);
                }
            }
        };

        async function init() {
            // æ˜¾ç¤ºè¿›åº¦æ¡
            progressManager.init();
            
            if (EXPORTED_DATA) {
                document.body.classList.add('exported-mode');
                CONFIG = EXPORTED_DATA.config;
                setTimeout(() => applyTextConfig(EXPORTED_DATA.text.fontKey, EXPORTED_DATA.text.line1, EXPORTED_DATA.text.line2, EXPORTED_DATA.text.size, EXPORTED_DATA.text.color), 100);
            }

            // æŒ‰æ­¥éª¤åˆå§‹åŒ–ï¼Œæ˜¾ç¤ºè¿›åº¦
            progressManager.update(1, 'åˆå§‹åŒ–3Då¼•æ“...');
            initThree();
            
            progressManager.next('è®¾ç½®ç¯å¢ƒ...');
            setupEnvironment();
            
            progressManager.next('æ·»åŠ å…‰æº...');
            setupLights();
            
            progressManager.next('åˆ›å»ºçº¹ç†...');
            createTextures();
            
            progressManager.next('ç”Ÿæˆç²’å­...');
            createParticles();
            createDust();
            createSnow();
            
            progressManager.next('åˆ›å»ºé»˜è®¤ç…§ç‰‡...');
            createDefaultPhotos();
            
            progressManager.next('è®¾ç½®åæœŸå¤„ç†...');
            setupPostProcessing();
            setupEvents();
            animate();
            
            const loader = document.getElementById('loader');
            if(loader) { loader.style.opacity = 0; setTimeout(() => loader.remove(), 500); }

            try {
                progressManager.next('åŠ è½½æœ¬åœ°æ•°æ®...');
                await initDB();
                if(!EXPORTED_DATA) loadTextConfig();
                const ps=await loadPhotosFromDB(); 
                if(ps?.length>0){ photoMeshGroup.clear(); particleSystem=particleSystem.filter(p=>p.type!=='PHOTO'); ps.forEach(i=>createPhotoTexture(i.data, i.id)); } 
                const ms=await loadMusicFromDB(); 
                if(ms){ bgmAudio.src=URL.createObjectURL(ms); if(EXPORTED_DATA) { document.body.addEventListener('click', () => { if(!isMusicPlaying) toggleMusicPlay(); }, { once: true }); } updatePlayBtnUI(false); } 
            } catch(e){console.warn(e);}
            
            progressManager.next('åˆå§‹åŒ–æ‰‹åŠ¿è¯†åˆ«...');
            await initMediaPipe(); 
            
            progressManager.next('å®Œæˆæœ€åè®¾ç½®...');
            initDraggableTitle();
            setMode('TREE');
            
            // å®Œæˆè¿›åº¦æ¡
            progressManager.complete();
            
            // æ˜¾ç¤ºæ‰‹åŠ¿æç¤º
            setTimeout(() => {
                const hint = document.getElementById('gesture-hint');
                if(hint) hint.classList.add('show');
                setTimeout(() => hint.classList.remove('show'), 4000);
            }, 1000);
        }

        function initDraggableTitle() { 
            const t=document.getElementById('title-container'); 
            let d=false,o={x:0,y:0}; 
            t.onmousedown=e=>{d=true;const r=t.getBoundingClientRect();o.x=e.clientX-r.left;o.y=e.clientY-r.top;t.style.transform='none';t.style.left=r.left+'px';t.style.top=r.top+'px'}; 
            window.onmousemove=e=>{if(d){t.style.left=(e.clientX-o.x)+'px';t.style.top=(e.clientY-o.y)+'px'}}; 
            window.onmouseup=()=>d=false; 
        }
        
        window.toggleUI=()=> { 
            STATE.uiVisible=!STATE.uiVisible; 
            document.getElementById('left-sidebar').classList.toggle('panel-hidden', !STATE.uiVisible); 
            document.getElementById('debug-info').classList.toggle('debug-hidden', !STATE.uiVisible);
            document.getElementById('top-right-controls').classList.toggle('panel-hidden', !STATE.uiVisible);
            
            // æ˜¾ç¤ºæç¤º
            const hint = document.getElementById('gesture-hint');
            hint.textContent = STATE.uiVisible ? "ç•Œé¢å·²æ˜¾ç¤º" : "ç•Œé¢å·²éšè—";
            hint.classList.add('show');
            setTimeout(() => hint.classList.remove('show'), 1500);
        };
        
        window.toggleCameraDisplay=()=> { 
            STATE.cameraVisible=!STATE.cameraVisible; 
            document.getElementById('webcam-wrapper').classList.toggle('camera-hidden', !STATE.cameraVisible); 
            const btn = document.getElementById('toggle-cam-btn');
            if(btn) btn.innerHTML = STATE.cameraVisible ? '<span>ğŸ“· éšè—ç”»é¢</span>' : '<span>ğŸ“· æ˜¾ç¤ºç”»é¢</span>';
        };
        
        window.toggleFullScreen=()=> { 
            if(!document.fullscreenElement)
                document.documentElement.requestFullscreen();
            else 
                document.exitFullscreen(); 
        };

        function loadTextConfig() { 
            const s=JSON.parse(localStorage.getItem('v16_text_config')); 
            if(s){ 
                document.getElementById('input-line1').value=s.line1||""; 
                document.getElementById('input-line2').value=s.line2||""; 
                document.getElementById('font-select').value=s.fontKey||"style1"; 
                document.getElementById('slider-fontsize').value=s.size||100; 
                document.getElementById('color-picker').value=s.color||"#fceea7"; 
                document.getElementById('size-value').textContent=s.size||100;
                applyTextConfig(s.fontKey,s.line1,s.line2,s.size,s.color); 
            } else { 
                document.getElementById('input-line1').value="Merry"; 
                document.getElementById('input-line2').value="Christmas"; 
                applyTextConfig("style1","Merry","Christmas",100,"#fceea7"); 
            } 
        }

        window.updateTextConfig=()=> { 
            const k=document.getElementById('font-select').value, 
                  l1=document.getElementById('input-line1').value, 
                  l2=document.getElementById('input-line2').value, 
                  s=document.getElementById('slider-fontsize').value, 
                  c=document.getElementById('color-picker').value; 
            
            // æ›´æ–°æ˜¾ç¤ºå€¼
            document.getElementById('size-value').textContent=s;
            
            localStorage.setItem('v16_text_config',JSON.stringify({fontKey:k,line1:l1,line2:l2,size:s,color:c})); 
            applyTextConfig(k,l1,l2,s,c); 
        };

        function applyTextConfig(k,l1,l2,s,c) { 
            const st=FONT_STYLES[k]||FONT_STYLES['style1']; 
            const t1=document.getElementById('display-line1'), t2=document.getElementById('display-line2'), ct=document.getElementById('title-container'); 
            ct.style.fontFamily=st.font; 
            t1.innerText=l1; 
            t2.innerText=l2; 
            t1.style.letterSpacing=st.spacing; 
            t2.style.letterSpacing=st.spacing; 
            t1.style.textShadow=st.shadow; 
            t2.style.textShadow=st.shadow; 
            t1.style.textTransform=st.transform; 
            t2.style.textTransform=st.transform; 
            t1.style.color=c; 
            t2.style.color=c; 
            t1.style.fontSize=(0.48*s)+"px"; 
            t2.style.fontSize=(0.48*s)+"px"; 
        }
        
        window.toggleMusicPlay=()=> { 
            if(!bgmAudio.src) {
                alert("è¯·å…ˆä¸Šä¼ éŸ³ä¹æ–‡ä»¶");
                return;
            }
            if(isMusicPlaying){ 
                bgmAudio.pause(); 
                isMusicPlaying=false; 
            } else { 
                bgmAudio.play().then(() => {
                    isMusicPlaying=true; 
                    updatePlayBtnUI(true);
                }).catch(e => {
                    console.error("éŸ³ä¹æ’­æ”¾å¤±è´¥:", e);
                    alert("éŸ³ä¹æ’­æ”¾å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶æ ¼å¼");
                });
            } 
        };

        window.replayMusic=()=> { 
            if(!bgmAudio.src) {
                alert("è¯·å…ˆä¸Šä¼ éŸ³ä¹æ–‡ä»¶");
                return;
            }
            bgmAudio.currentTime=0; 
            bgmAudio.play(); 
            isMusicPlaying=true; 
            updatePlayBtnUI(true);
        };

        window.updateVolume=(v)=> { 
            bgmAudio.volume=v/100; 
            document.getElementById('volume-value').textContent=v;
        };

        function updatePlayBtnUI(p) { 
            const btn = document.getElementById('play-btn');
            const icon = document.getElementById('play-icon');
            const text = document.getElementById('play-text');
            if(p) {
                icon.textContent = "â¸";
                text.textContent = "æš‚åœ";
            } else {
                icon.textContent = "â¯";
                text.textContent = bgmAudio.src ? "æ’­æ”¾" : "æœªä¸Šä¼ ";
            }
        }

        window.updateRotationSpeed=(v)=> { 
            CONFIG.interaction.rotationSpeed = parseFloat(v);
            document.getElementById('rotation-value').textContent=v;
        };
        
        window.setMode = function(mode) {
            STATE.mode = mode;
            STATE.focusTarget = null;
            const hint = document.getElementById('gesture-hint');
            
            let message = "";
            if(mode === 'TREE') message = "çŠ¶æ€: èšåˆ (æ¡æ‹³ä¿æŒ / å¼ å¼€äº”æŒ‡å±•ç¤ºç…§ç‰‡)";
            else if(mode === 'SCATTER') message = "çŠ¶æ€: æ•£å¼€ (å¼ å¼€äº”æŒ‡åˆ‡æ¢ / æ¡æ‹³è¿”å›)";
            else if(mode === 'FOCUS') message = "çŠ¶æ€: è§‚èµ (å¼ å¼€äº”æŒ‡åˆ‡æ¢ / æ¡æ‹³è¿”å›)";
            
            hint.textContent = message;
            hint.classList.add('show');
            setTimeout(() => hint.classList.remove('show'), 3000);
        }

        window.cycleNextPhoto = () => {
            if(isAnimating) return; 
            isAnimating = true;

            const photoParticles = particleSystem.filter(p => p.type === 'PHOTO');
            if (photoParticles.length === 0) { 
                isAnimating = false; 
                const hint = document.getElementById('gesture-hint');
                hint.textContent = "æš‚æ— ç…§ç‰‡ï¼Œè¯·å…ˆä¸Šä¼ ";
                hint.classList.add('show');
                setTimeout(() => hint.classList.remove('show'), 2000);
                return; 
            }

            let startDelay = 0;
            if(STATE.mode === 'TREE') startDelay = 50; 
            else { setMode('TREE'); startDelay = 1000; }

            const hint = document.getElementById('gesture-hint');
            hint.textContent = "è‡ªåŠ¨è½®æ’­ä¸­...";
            hint.classList.add('show');

            setTimeout(() => {
                setMode('SCATTER');
                setTimeout(() => {
                    currentPhotoIndex = (currentPhotoIndex + 1) % photoParticles.length;
                    setMode('FOCUS');
                    STATE.focusTarget = photoParticles[currentPhotoIndex].mesh;
                    STATE.focusType = Math.floor(Math.random() * 4);

                    setTimeout(() => {
                        isAnimating = false;
                        hint.classList.remove('show');
                        if (INPUTS.z || INPUTS.handOpen) cycleNextPhoto();
                        else if ((INPUTS.space || INPUTS.handFist) && STATE.mode !== 'TREE') cycleNextPhoto();
                    }, 1000); 
                }, 500); 
            }, startDelay); 
        };
        
        window.startRotate=(d)=> { 
            if(d==='up')manualRotateState.x=-1; 
            if(d==='down')manualRotateState.x=1; 
            if(d==='left')manualRotateState.y=-1; 
            if(d==='right')manualRotateState.y=1; 
        };
        window.stopRotate=()=> { 
            manualRotateState={x:0,y:0}; 
        };
        window.resetRotation=()=> { 
            STATE.rotation={x:0,y:0}; 
            if(STATE.mode!=='TREE')setMode('TREE');
            const hint = document.getElementById('gesture-hint');
            hint.textContent = "æ—‹è½¬å·²é‡ç½®";
            hint.classList.add('show');
            setTimeout(() => hint.classList.remove('show'), 1500);
        };

        window.setupEvents = function() {
            // ç¡®ä¿æ‰€æœ‰UIå…ƒç´ åœ¨åˆå§‹åŒ–åéƒ½å¯è§
            setTimeout(() => {
                document.getElementById('top-right-controls').classList.remove('panel-hidden');
                document.getElementById('left-sidebar').classList.remove('panel-hidden');
                STATE.uiVisible = true;
            }, 100);

            window.addEventListener('resize', () => { 
                if(camera && renderer && composer) {
                    camera.aspect = window.innerWidth/window.innerHeight; 
                    camera.updateProjectionMatrix(); 
                    renderer.setSize(window.innerWidth, window.innerHeight); 
                    composer.setSize(window.innerWidth, window.innerHeight); 
                }
            });
            
            document.getElementById('file-input').addEventListener('change', (e) => {
                const files = e.target.files; if(!files.length) return;
                const hint = document.getElementById('gesture-hint');
                hint.textContent = `æ­£åœ¨å¤„ç† ${files.length} å¼ ç…§ç‰‡...`;
                hint.classList.add('show');
                
                Array.from(files).forEach(f => {
                    const reader = new FileReader();
                    reader.onload = (ev) => {
                        const base64 = ev.target.result;
                        const id = savePhotoToDB(base64);
                        createPhotoTexture(base64, id);
                    }
                    reader.readAsDataURL(f);
                });
                
                setTimeout(() => {
                    hint.textContent = "ç…§ç‰‡ä¸Šä¼ å®Œæˆï¼";
                    setTimeout(() => hint.classList.remove('show'), 1500);
                }, 1000);
            });

            document.getElementById('music-input').addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    saveMusicToDB(file);
                    bgmAudio.src = URL.createObjectURL(file);
                    const hint = document.getElementById('gesture-hint');
                    hint.textContent = "éŸ³ä¹å·²åŠ è½½ï¼Œç‚¹å‡»æ’­æ”¾";
                    hint.classList.add('show');
                    setTimeout(() => hint.classList.remove('show'), 2000);
                    updatePlayBtnUI(false);
                }
            });

            window.addEventListener('keydown', (e) => {
                if (e.target.tagName === 'INPUT' || e.target.tagName === 'SELECT') return;
                const k = e.key.toLowerCase();
                const code = e.code;
                if (k === 'h') window.toggleUI();
                if (code === 'Space') { 
                    e.preventDefault(); 
                    INPUTS.space = true;
                    if(STATE.mode !== 'TREE' && !isAnimating) {
                        if(STATE.mode !== 'TREE') setMode('TREE');
                    }
                }
                if (k === 'z') { INPUTS.z = true; if(!isAnimating) cycleNextPhoto(); }
                if (code === 'ArrowUp') manualRotateState.x = -1;
                if (code === 'ArrowDown') manualRotateState.x = 1;
                if (code === 'ArrowLeft') manualRotateState.y = -1;
                if (code === 'ArrowRight') manualRotateState.y = 1;
            });

            window.addEventListener('keyup', (e) => {
                const k = e.key.toLowerCase();
                const code = e.code;
                if (k === 'z') INPUTS.z = false;
                if (code === 'Space') INPUTS.space = false;
                if (['ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight'].includes(code)) {
                    manualRotateState = { x: 0, y: 0 };
                }
            });
        }

        function initThree() { 
            const c=document.getElementById('canvas-container'); 
            scene=new THREE.Scene(); 
            scene.background=new THREE.Color(CONFIG.colors.bg); 
            scene.fog=new THREE.FogExp2(CONFIG.colors.bg,0.01); 
            camera=new THREE.PerspectiveCamera(42,window.innerWidth/window.innerHeight,0.1,1000); 
            camera.position.set(0,2,CONFIG.camera.z); 
            renderer=new THREE.WebGLRenderer({antialias:true,alpha:false,powerPreference:"high-performance"}); 
            renderer.setSize(window.innerWidth,window.innerHeight); 
            renderer.setPixelRatio(Math.min(window.devicePixelRatio,2)); 
            renderer.toneMapping=THREE.ReinhardToneMapping; 
            renderer.toneMappingExposure=2.2; 
            c.appendChild(renderer.domElement); 
            mainGroup=new THREE.Group(); 
            scene.add(mainGroup); 
        }

        function setupEnvironment() { 
            const p=new THREE.PMREMGenerator(renderer); 
            scene.environment=p.fromScene(new RoomEnvironment(),0.04).texture; 
        }

        function setupLights() { 
            scene.add(new THREE.AmbientLight(0xffffff,0.6)); 
            const i=new THREE.PointLight(0xffaa00,2,20); 
            i.position.set(0,5,0); 
            mainGroup.add(i); 
            const s1=new THREE.SpotLight(0xffcc66,1200); 
            s1.position.set(30,40,40); 
            s1.angle=0.5; 
            s1.penumbra=0.5; 
            scene.add(s1); 
            const s2=new THREE.SpotLight(0x6688ff,600); 
            s2.position.set(-30,20,-30); 
            scene.add(s2); 
            const f=new THREE.DirectionalLight(0xffeebb,0.8); 
            f.position.set(0,0,50); 
            scene.add(f); 
        }

        function setupPostProcessing() { 
            const r=new RenderPass(scene,camera); 
            const b=new UnrealBloomPass(new THREE.Vector2(window.innerWidth,window.innerHeight),1.5,0.4,0.85); 
            b.threshold=0.7; 
            b.strength=0.45; 
            b.radius=0.4; 
            composer=new EffectComposer(renderer); 
            composer.addPass(r); 
            composer.addPass(b); 
        }

        function createTextures() { 
            const c=document.createElement('canvas'); 
            c.width=128; 
            c.height=128; 
            const x=c.getContext('2d'); 
            x.fillStyle='#ffffff'; 
            x.fillRect(0,0,128,128); 
            x.fillStyle='#880000'; 
            x.beginPath(); 
            for(let i=-128;i<256;i+=32){x.moveTo(i,0);x.lineTo(i+32,128);x.lineTo(i+16,128);x.lineTo(i-16,0);} 
            x.fill(); 
            caneTexture=new THREE.CanvasTexture(c); 
            caneTexture.wrapS=caneTexture.wrapT=THREE.RepeatWrapping; 
            caneTexture.repeat.set(3,3); 
        }

        window.updateSnowSettings=()=> { 
            CONFIG.snow.sizeBase=parseFloat(document.getElementById('slider-snow-size').value); 
            CONFIG.snow.count=parseInt(document.getElementById('slider-snow-count').value); 
            document.getElementById('snow-size-value').textContent=CONFIG.snow.sizeBase;
            document.getElementById('snow-count-value').textContent=CONFIG.snow.count;
            createSnow(); 
        };

        window.updateSnowSpeed=(v)=> { 
            CONFIG.snow.speed=parseFloat(v);
            document.getElementById('snow-speed-value').textContent=v;
        };

        function createSnow() {
            if(snowInstancedMesh){scene.remove(snowInstancedMesh); snowInstancedMesh.geometry.dispose(); snowInstancedMesh.material.dispose(); snowInstancedMesh=null; snowData=[];}
            if(CONFIG.snow.count<=0)return;
            const g=new THREE.IcosahedronGeometry(CONFIG.snow.sizeBase,0);
            const m=new THREE.MeshPhysicalMaterial({color:0xffffff,metalness:0,roughness:0.15,transmission:0.9,thickness:0.5,envMapIntensity:1.5,clearcoat:1,clearcoatRoughness:0.1,ior:1.33});
            snowInstancedMesh=new THREE.InstancedMesh(g,m,CONFIG.snow.count); snowInstancedMesh.instanceMatrix.setUsage(THREE.DynamicDrawUsage);
            for(let i=0;i<CONFIG.snow.count;i++){
                snowDummy.position.set((Math.random()-0.5)*CONFIG.snow.range, Math.random()*CONFIG.snow.range, (Math.random()-0.5)*CONFIG.snow.range);
                snowDummy.rotation.set(Math.random()*Math.PI,Math.random()*Math.PI,Math.random()*Math.PI);
                const s=0.5+Math.random()*CONFIG.snow.sizeVar; 
                snowDummy.scale.set(s,s,s); 
                snowDummy.updateMatrix();
                snowInstancedMesh.setMatrixAt(i,snowDummy.matrix);
                snowData.push({vy:(Math.random()*0.5+0.8), rx:(Math.random()-0.5)*2, ry:(Math.random()-0.5)*2, rz:(Math.random()-0.5)*2});
            } 
            scene.add(snowInstancedMesh);
        }

        class Particle {
            constructor(m,t,d=false){this.mesh=m;this.type=t;this.isDust=d;this.posTree=new THREE.Vector3();this.posScatter=new THREE.Vector3();this.baseScale=m.scale.x;this.photoId=null;const s=(t==='PHOTO')?0.3:2.0;this.spinSpeed=new THREE.Vector3((Math.random()-0.5)*s,(Math.random()-0.5)*s,(Math.random()-0.5)*s);this.calcPos();}
            calcPos(){const h=CONFIG.particles.treeHeight;let t=Math.pow(Math.random(),0.8);const y=(t*h)-(h/2);let rm=Math.max(0.5,CONFIG.particles.treeRadius*(1.0-t));const a=t*50*Math.PI+Math.random()*Math.PI;const r=rm*(0.8+Math.random()*0.4);this.posTree.set(Math.cos(a)*r,y,Math.sin(a)*r);let rs=this.isDust?(12+Math.random()*20):(8+Math.random()*12);const th=Math.random()*Math.PI*2,ph=Math.acos(2*Math.random()-1);this.posScatter.set(rs*Math.sin(ph)*Math.cos(th),rs*Math.sin(ph)*Math.sin(th),rs*Math.cos(ph));}
            update(dt,mode,ft){
                let tg=this.posTree; 
                if(mode==='SCATTER') tg=this.posScatter; 
                else if(mode==='FOCUS'){
                    if(this.mesh===ft){
                        let off=new THREE.Vector3(0, 1.8, 35); 
                        if(STATE.focusType===1) off.set(-0.3, 2.0, 34);
                        else if(STATE.focusType===2) off.set(0.3, 1.6, 35);
                        else if(STATE.focusType===3) off.set(0, 1.5, 34.5);
                        
                        const im=new THREE.Matrix4().copy(mainGroup.matrixWorld).invert();
                        tg=off.applyMatrix4(im);
                    } else tg=this.posScatter;
                }
                const ls=(mode==='FOCUS'&&this.mesh===ft)?8.0:4.0; this.mesh.position.lerp(tg,ls*dt);
                if(mode==='SCATTER'){this.mesh.rotation.x+=this.spinSpeed.x*dt;this.mesh.rotation.y+=this.spinSpeed.y*dt;this.mesh.rotation.z+=this.spinSpeed.z*dt;}else if(mode==='TREE'){this.mesh.rotation.x=THREE.MathUtils.lerp(this.mesh.rotation.x,0,dt);this.mesh.rotation.z=THREE.MathUtils.lerp(this.mesh.rotation.z,0,dt);this.mesh.rotation.y+=0.5*dt;}
                if(mode==='FOCUS'&&this.mesh===ft){this.mesh.lookAt(camera.position);if(STATE.focusType===1)this.mesh.rotateZ(0.38);if(STATE.focusType===2)this.mesh.rotateZ(-0.15);if(STATE.focusType===3)this.mesh.rotateX(-0.4);}
                
                let s=this.baseScale;
                if(this.isDust){s=this.baseScale*(0.8+0.4*Math.sin(clock.elapsedTime*4+this.mesh.id));if(mode==='TREE')s=0;}
                else if(mode==='SCATTER'&&this.type==='PHOTO')s=this.baseScale*2.5;
                else if(mode==='FOCUS'){
                    if(this.mesh===ft){
                        if(STATE.focusType===2) s=7.5; 
                        else if(STATE.focusType===3) s=8.0; 
                        else s=7.0;
                    } else s=this.baseScale*0.8;
                }
                this.mesh.scale.lerp(new THREE.Vector3(s,s,s),6*dt);
            }
        }

        function createParticles() {
            const sg=new THREE.SphereGeometry(0.5,32,32); const bg=new THREE.BoxGeometry(0.55,0.55,0.55); const c=new THREE.CatmullRomCurve3([new THREE.Vector3(0,-0.5,0),new THREE.Vector3(0,0.3,0),new THREE.Vector3(0.1,0.5,0),new THREE.Vector3(0.3,0.4,0)]); const cg=new THREE.TubeGeometry(c,16,0.08,8,false);
            const gm=new THREE.MeshStandardMaterial({color:CONFIG.colors.champagneGold,metalness:1,roughness:0.1,envMapIntensity:2,emissive:0x443300,emissiveIntensity:0.3});
            const grm=new THREE.MeshStandardMaterial({color:CONFIG.colors.deepGreen,metalness:0.2,roughness:0.8,emissive:0x002200,emissiveIntensity:0.2});
            const rm=new THREE.MeshPhysicalMaterial({color:CONFIG.colors.accentRed,metalness:0.3,roughness:0.2,clearcoat:1,emissive:0x330000});
            const cm=new THREE.MeshStandardMaterial({map:caneTexture,roughness:0.4});
            for(let i=0;i<CONFIG.particles.count;i++){const r=Math.random();let m,t;if(r<0.4){m=new THREE.Mesh(bg,grm);t='BOX';}else if(r<0.7){m=new THREE.Mesh(bg,gm);t='GOLD_BOX';}else if(r<0.92){m=new THREE.Mesh(sg,gm);t='GOLD_SPHERE';}else if(r<0.97){m=new THREE.Mesh(sg,rm);t='RED';}else{m=new THREE.Mesh(cg,cm);t='CANE';}const s=0.4+Math.random()*0.5;m.scale.set(s,s,s);m.rotation.set(Math.random()*6,Math.random()*6,Math.random()*6);mainGroup.add(m);particleSystem.push(new Particle(m,t,false));}
            const st=new THREE.Mesh(new THREE.OctahedronGeometry(1.2,0),new THREE.MeshStandardMaterial({color:0xffdd88,emissive:0xffaa00,emissiveIntensity:1,metalness:1,roughness:0}));st.position.set(0,CONFIG.particles.treeHeight/2+1.2,0);mainGroup.add(st);mainGroup.add(photoMeshGroup);
        }
        function createDust(){const g=new THREE.TetrahedronGeometry(0.08,0);const m=new THREE.MeshBasicMaterial({color:0xffeebb,transparent:true,opacity:0.8});for(let i=0;i<CONFIG.particles.dustCount;i++){const ms=new THREE.Mesh(g,m);ms.scale.setScalar(0.5+Math.random());mainGroup.add(ms);particleSystem.push(new Particle(ms,'DUST',true));}}
        function createDefaultPhotos(){const c=document.createElement('canvas');c.width=512;c.height=512;const x=c.getContext('2d');x.fillStyle='#050505';x.fillRect(0,0,512,512);x.strokeStyle='#eebb66';x.lineWidth=15;x.strokeRect(20,20,472,472);x.font='500 60px Times New Roman';x.fillStyle='#eebb66';x.textAlign='center';x.fillText("JOYEUX",256,230);x.fillText("NOEL",256,300);createPhotoTexture(c.toDataURL(),'default');}
        function createPhotoTexture(b,id){const i=new Image();i.src=b;i.onload=()=>{const t=new THREE.Texture(i);t.colorSpace=THREE.SRGBColorSpace;t.needsUpdate=true;addPhotoToScene(t,id,i);}}
        function addPhotoToScene(t,id,imgObj){
            const aspect=imgObj.width/imgObj.height; let w=1.2,h=1.2; if(aspect>1)h=w/aspect; else w=h*aspect;
            const fg=new THREE.BoxGeometry(w+0.05,h+0.05,0.05); 
            const fm=new THREE.MeshStandardMaterial({color:0xc5a059,metalness:0.6,roughness:0.5,envMapIntensity:0.5}); const f=new THREE.Mesh(fg,fm); const pg=new THREE.PlaneGeometry(w,h); const pm=new THREE.MeshBasicMaterial({map:t}); const p=new THREE.Mesh(pg,pm); p.position.z=0.04; const g=new THREE.Group(); g.add(f); g.add(p); const s=0.8; g.scale.set(s,s,s); photoMeshGroup.add(g); const pt=new Particle(g,'PHOTO',false); pt.photoId=id; pt.texture=t; particleSystem.push(pt);
        }
        window.applyParticleSettings=()=>{const ph=particleSystem.filter(p=>p.type==='PHOTO');const tr=[];mainGroup.children.forEach(c=>{if(c!==photoMeshGroup)tr.push(c)});tr.forEach(c=>mainGroup.remove(c));particleSystem=[...ph];CONFIG.particles.count=parseInt(document.getElementById('slider-tree').value);CONFIG.particles.dustCount=parseInt(document.getElementById('slider-dust').value);createParticles();createDust();createSnow();};

        async function initMediaPipe(){
            const debug = document.getElementById('debug-info');
            videoElement=document.getElementById('webcam-video');
            
            debug.innerText = "æ­£åœ¨ä¸‹è½½æ‰‹åŠ¿è¯†åˆ«æ¨¡å‹ (çº¦10MB)...";
            
            if(navigator.mediaDevices?.getUserMedia){
                try{
                    const s=await navigator.mediaDevices.getUserMedia({video: { width: 640, height: 480, frameRate: { ideal: 30 } }});
                    videoElement.srcObject=s;
                    videoElement.onloadedmetadata=()=>{videoElement.play();renderWebcamPreview()};
                }catch(e){
                    console.error(e);
                    debug.innerText = "æ‘„åƒå¤´å¯åŠ¨å¤±è´¥! è¯·æ£€æŸ¥æƒé™";
                    debug.classList.remove('loading-center');
                    return;
                }
            }
            
            try{
                const v=await FilesetResolver.forVisionTasks("https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.3/wasm");
                handLandmarker=await HandLandmarker.createFromOptions(v,{
                    baseOptions:{modelAssetPath:`https://storage.googleapis.com/mediapipe-models/hand_landmarker/hand_landmarker/float16/1/hand_landmarker.task`,delegate:"CPU"},
                    runningMode:"VIDEO",
                    numHands:1,
                    minHandDetectionConfidence: 0.2, 
                    minHandPresenceConfidence: 0.2,
                    minTrackingConfidence: 0.2
                });
                
                debug.classList.remove('loading-center');
                debug.innerText = "æ¨¡å‹åŠ è½½æˆåŠŸ! æ­£åœ¨å¯»æ‰¾æ‰‹æŒ...";
                predictWebcam();
            }catch(e){
                console.warn(e);
                debug.innerText = "æ¨¡å‹åŠ è½½å¤±è´¥! (ç½‘ç»œè¿æ¥è¶…æ—¶/è·¨åŸŸ)";
            }
        }
        
        function renderWebcamPreview(){const c=document.getElementById('webcam-canvas'),x=c.getContext('2d',{willReadFrequently:true});function d(){if(videoElement.readyState>=2)x.drawImage(videoElement,0,0,c.width,c.height);requestAnimationFrame(d)}d()}
        
        let lastVideoTime = -1;
        async function predictWebcam(){
            if(handLandmarker && videoElement && videoElement.readyState >= 2) {
                let startTimeMs = performance.now();
                if (lastVideoTime !== videoElement.currentTime) {
                    lastVideoTime = videoElement.currentTime;
                    const results = handLandmarker.detectForVideo(videoElement, startTimeMs);
                    
                    // === VISUAL DEBUG: DRAW SKELETON ===
                    const canvas = document.getElementById('webcam-canvas');
                    const ctx = canvas.getContext('2d');
                    const drawingUtils = new DrawingUtils(ctx);
                    
                    if (results.landmarks) {
                        for (const landmarks of results.landmarks) {
                            drawingUtils.drawConnectors(landmarks, HandLandmarker.HAND_CONNECTIONS, { color: "#FF0000", lineWidth: 3 });
                            drawingUtils.drawLandmarks(landmarks, { color: "#00FF00", lineWidth: 1 });
                        }
                    }
                    // ===================================

                    processGestures(results);
                    document.getElementById('cam-status').classList.toggle('active', results.landmarks.length > 0);
                }
            }
            requestAnimationFrame(predictWebcam);
        }
        
        function processGestures(r){
            const debug = document.getElementById('debug-info');
            if(r.landmarks&&r.landmarks.length>0){
                STATE.hand.detected=true;
                const lm=r.landmarks[0];
                // Mirror X for interaction logic too
                STATE.hand.x=( (1 - lm[9].x) -0.5)*2; 
                STATE.hand.y=(lm[9].y-0.5)*2;
                const thumb=lm[4], index=lm[8];
                const pd=Math.hypot(thumb.x-index.x, thumb.y-index.y); 
                
                // --- SMOOTH SIGNAL LOGIC ---
                if(gestureLossTimer) { clearTimeout(gestureLossTimer); gestureLossTimer = null; }

                if(pd < 0.08) { 
                    INPUTS.handFist = true; INPUTS.handOpen = false;
                    debug.innerText = `[âœŠ æ¡æ‹³] (æ•°å€¼: ${pd.toFixed(3)})`;
                    if(STATE.mode !== 'TREE' && !isAnimating) setMode('TREE');
                } else if(pd > 0.13) { 
                    INPUTS.handOpen = true; INPUTS.handFist = false;
                    debug.innerText = `[ğŸ– å¼ å¼€] (æ•°å€¼: ${pd.toFixed(3)})`;
                    if(!isAnimating) cycleNextPhoto();
                } else {
                    debug.innerText = `[---] (æ•°å€¼: ${pd.toFixed(3)})`;
                }
            } else {
                STATE.hand.detected=false;
                if(!gestureLossTimer) {
                    gestureLossTimer = setTimeout(() => {
                        INPUTS.handOpen = false;
                        INPUTS.handFist = false;
                        debug.innerText = `[æ£€æµ‹æ´»è·ƒ: ${Math.floor(performance.now()/1000)}]`;
                    }, 300); 
                }
            }
        }

        window.openDeleteManager=async()=>{document.getElementById('delete-manager').classList.remove('hidden');const g=document.getElementById('photo-grid');g.innerHTML='';const ps=await loadPhotosFromDB();if(!ps||ps.length===0)g.innerHTML='<div style="color:#888; text-align:center; padding:40px;">æš‚æ— ç…§ç‰‡<br><small style="opacity:0.6;">ç‚¹å‡»"+ ä¸Šä¼ ç…§ç‰‡"æ·»åŠ </small></div>';else ps.forEach(p=>{const d=document.createElement('div');d.className='photo-item';const i=document.createElement('img');i.className='photo-thumb';i.src=p.data;const b=document.createElement('div');b.className='delete-x';b.innerText='Ã—';b.onclick=e=>{e.stopPropagation();confirmDelete(p.id,d)};d.appendChild(i);d.appendChild(b);g.appendChild(d)})}
        window.confirmDelete=(id,el)=>{deletePhotoFromDB(id);el.remove();const p=particleSystem.find(pa=>pa.photoId===id);if(p){photoMeshGroup.remove(p.mesh);particleSystem.splice(particleSystem.indexOf(p),1)}}
        window.clearAllPhotos=()=>{if(confirm("ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰ç…§ç‰‡å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚")){clearPhotosDB();particleSystem.filter(p=>p.type==='PHOTO').forEach(p=>photoMeshGroup.remove(p.mesh));particleSystem=particleSystem.filter(p=>p.type!=='PHOTO');window.openDeleteManager()}}
        window.closeDeleteManager=()=>{document.getElementById('delete-manager').classList.add('hidden')}

        function animate() {
            requestAnimationFrame(animate); 
            const dt=clock.getDelta(); 
            const et=clock.getElapsedTime();
            
            if(snowInstancedMesh&&STATE.mode==='TREE'){
                snowInstancedMesh.visible=true;
                for(let i=0;i<CONFIG.snow.count;i++){
                    snowInstancedMesh.getMatrixAt(i,snowDummy.matrix);snowDummy.matrix.decompose(snowDummy.position,snowDummy.quaternion,snowDummy.scale);const d=snowData[i];
                    snowDummy.position.y-=d.vy*CONFIG.snow.speed*dt;snowDummy.position.x+=Math.sin(et*0.5+i)*2.5*dt;snowDummy.position.z+=Math.cos(et*0.3+i)*1.5*dt;
                    snowDummy.rotation.x+=d.rx*dt;snowDummy.rotation.y+=d.ry*dt;snowDummy.rotation.z+=d.rz*dt;
                    if(snowDummy.position.y<-25){snowDummy.position.y=40;snowDummy.position.x=(Math.random()-0.5)*CONFIG.snow.range;snowDummy.position.z=(Math.random()-0.5)*CONFIG.snow.range;}
                    snowDummy.updateMatrix();snowInstancedMesh.setMatrixAt(i,snowDummy.matrix);
                } snowInstancedMesh.instanceMatrix.needsUpdate=true;
            } else if(snowInstancedMesh)snowInstancedMesh.visible=false;
            
            if(manualRotateState.x!==0||manualRotateState.y!==0){
                const s=CONFIG.interaction.rotationSpeed*2.0;
                STATE.rotation.x+=manualRotateState.x*s*dt;
                STATE.rotation.y+=manualRotateState.y*s*dt;
            }
            else if(STATE.mode==='SCATTER'&&STATE.hand.detected){
                const th=0.3,s=CONFIG.interaction.rotationSpeed;
                if(STATE.hand.x>th)STATE.rotation.y-=s*dt*(STATE.hand.x-th);
                else if(STATE.hand.x<-th)STATE.rotation.y-=s*dt*(STATE.hand.x+th);
                if(STATE.hand.y<-th)STATE.rotation.x+=s*dt*(-STATE.hand.y-th);
                else if(STATE.hand.y>th)STATE.rotation.x-=s*dt*(STATE.hand.y-th);
            }
            else{
                if(STATE.mode==='TREE'){
                    STATE.rotation.y+=0.3*dt;
                    STATE.rotation.x+=(0-STATE.rotation.x)*2.0*dt;
                } else {
                    STATE.rotation.y+=0.1*dt;
                }
            }
            
            mainGroup.rotation.y=STATE.rotation.y;
            mainGroup.rotation.x=STATE.rotation.x;
            particleSystem.forEach(p=>p.update(dt,STATE.mode,STATE.focusTarget));
            composer.render();
        }

        init();
    </script>
</body>
</html>
